<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="o一行瑠璃o">
  <meta name="keywords" content="学习笔记,Java,C">
  <title>05.SpringCloud--学习笔记 - 知晓天空之蓝的人啊</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Hello World</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                目录
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/indexbg/sun.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-07-15 11:24">
      2020年7月15日 上午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      38.8k 字
    </span>
  

  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="SpringCloud–学习笔记-包含SpringCloud视频"><a href="#SpringCloud–学习笔记-包含SpringCloud视频" class="headerlink" title="SpringCloud–学习笔记(包含SpringCloud视频)"></a>SpringCloud–学习笔记(包含SpringCloud视频)</h1><h2 id="Lesson1-微服务架构概述"><a href="#Lesson1-微服务架构概述" class="headerlink" title="Lesson1 微服务架构概述"></a>Lesson1 微服务架构概述</h2><h3 id="NO1-1-微服务架构简介"><a href="#NO1-1-微服务架构简介" class="headerlink" title="NO1.1 微服务架构简介"></a>NO1.1 微服务架构简介</h3><p>SOA是什么？SOA(面向服务的架构)不是具体的什么技术，而是一种开发项目的思想，这种思想开发的项目有很多好处，更符合现在的互联网系统快速发展的时代。</p>
<ul>
<li><p>微服务架构，咱们举个通俗易懂的例子：</p>
<ul>
<li><p>问题设计：比如现在我有一个数据库，一个JavaWeb(或者PHP等)的网站客户端，一个安卓App客户端，一个IOS客户端；现在我要给用户提供一个注册账号的功能；</p>
<ul>
<li><code>不用SOA的设计思想的实现</code>：JavaWeb里面写一个注册账号的功能，安卓App里面写一个注册账号的功能，IOS同样如此；那么这样的实现有没有什么问题呢？比如有一天，我的注册方法需要改动，那是不是三个地方都要改，而且要改的一模一样；当然问题不止这一个….；</li>
<li><code>SOA的设计思想实现</code>：用Java(或者是其他语言皆可)单独创建一个工程部署在一台服务器上，并且写一个方法(或称函数)执行上述注册操作，然后提供一个接口，其他人可以通过某种途径(可以是http链接，或者是基于socket的RPC调用)访问这个方法来使用这个注册功能；就是说把这个操作封装到一个工程中去，然后暴露访问的方式，形成“服务”；如果要修改关于注册这个功能的业务逻辑什么的，只要改这个服务就好了，很好的解耦；这样有什么优缺点呢？<ul>
<li>优点：<ul>
<li>扩展方便：一旦哪天突然有一堆人要注册，假设这堆人仅仅只是注册而不做其他事情，注册这个功能压力很大，而原有的一台部署了注册服务的服务器已经承受不了这么高的并发，这时候就可以单独集群部署这个注册服务，多提供几台服务器来提供注册的服务；</li>
<li>语言通用：实现这个服务的可以是任何语言，只要提供的接口通用就可以了，比如PHP擅长处理逻辑、Ruby语言擅长高并发、Java擅长大数据等，那我可以这样子做：在某些业务逻辑很复杂的服务中使用PHP，在某些并发很高的服务中使用Ruby….；</li>
<li>新人友好：新人进公司的时候他无需了解整个项目的架构是怎样的，比如你进阿里了，你想要熟练整个淘宝的架构你会累死，而这种SOA思想开发的项目由于是服务形式的，比方把你分到购物车组，那你只需要了解购物车的功能就好了；</li>
<li>发版方便：比方说你是淘宝购物车项目组的，你的项目改了一些东西要发版(发布生产)，如果你是传统项目测试，可能怕你改动到了其他的东西影响到了其他的功能(虽然你很确信没改动到，但万一呢？)，不得不对淘宝整体的功能都做一遍测试，累死人，而这种形式的测试只需要测试你的购物车的功能，so easy；退一步说，万一你改的代码有问题测试没测出来，那也是影响购物车的功能，用户下单支付不影响；</li>
</ul>
</li>
<li>缺点：<ul>
<li>问题排查不便：比方用户买东西的时候出现了一个报错，很难直接定位到问题出在哪个环节，可能是订单组的代码有问题，也可能是支付组的代码有问题；</li>
<li>沟通不便：如果你们在大公司待过的话就会明白，用户组、订单组、购物车组、支付组等等是分别属于不同的领导管理，出了问题沟通起来很麻烦，甚至你都不知道找谁沟通，也可能以前跟你沟通的人后来离职了等等的问题；</li>
<li>性能问题：相对于传统项目的直接调用，SOA中不管你是使用RPC还是什么HTTP等技术调用，肯定会有性能的损耗，因为网络通信是需要时间的；</li>
<li>关系混乱：当服务越来越多，调用方也越来越多的时候，它们之间的关系就变得非常混乱；</li>
</ul>
</li>
</ul>
</li>
<li>总结：整体而言SOA肯定是利大于弊的，虽然缺点很明显，但是基本都是可以克服的，问题排查不便那就对花点时间呗，沟通不便就找上级领导多沟通呗，性能问题用内网什么的也能降低到很少，关系乱就可以用服务治理；相对而言，好处部分基本上是传统“Only One”项目不可能克服的，比如非SOA项目扩展基本很难，全部的代码丢到一个项目里面，类似淘宝这种，新人可能看三年五年也看不懂；</li>
</ul>
</li>
<li><p>问题设计：还是上面的例子，假如我有一个用户服务，一开始有调用方1和调用方2来使用这个服务，后来越来越多，将近上百个调用方，这个时候作为服务方，它只知道提供服务，却不知道具体为谁提供了服务；而对于开发者来说，知道这N多调用方和N多服务方之间的关系是非常重要的，所以这个时候就需要能进行服务治理的框架，比如dubbo+zookeeper，比如SpringCloud，有了服务治理功能，我们就能清晰地看到服务被谁谁谁调用，谁谁谁调用了哪些服务，哪些服务是热点服务需要配置服务器集群，而对这个服务集群的负载均衡也是服务治理可以完成的重要功能之一；</p>
<ul>
<li><p>总结：实际上SOA只是一种架构设计模式，而SOAP、REST、RPC就是根据这种设计模式构建出来的规范，其中SOAP通俗理解就是http+xml的形式，REST就是http+json的形式，RPC是基于socket的形式；CXF就是典型的SOAP/REST框架，dubbo就是典型的RPC框架，而SpringCloud就是遵守REST规范的生态系统。</p>
</li>
<li><p>最后的总结：什么是微服务？简单来说，微服务是一种架构模式，叫微服务架构更合理，就是把一个系统中的各个功能点都拆开为一个个的小应用然后单独部署，同时因为这些小应用多，所以需要一些办法来管理这些小应用。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO1-2-SpringCluod简介"><a href="#NO1-2-SpringCluod简介" class="headerlink" title="NO1.2 SpringCluod简介"></a>NO1.2 SpringCluod简介</h3><p>Spring Cloud是什么？简单来说，Spring Cloud是一个微服务框架的规范，这里要注意，只是规范，它不是任何具体的框架。</p>
<ul>
<li>我们知道Java大佬最喜欢的做法就是自己制定规范，然后别人基于我这个规范来做实现。那么这个规范里面有什么呢，它规定大概要有这几种功能：服务的注册与发现、负载均衡、服务熔断和限流、智能路由、控制总线、链路监控….等等。刚好，这个时候有一个框架集合，几乎能满足上面所有的需求，它就是Spring Cloud Netflix。当然，Spring Cloud的实现产品不止这一个，还有最近由阿里新起的Spring Cloud Alibaba等，目前国内主流的是Spring Cloud Netflix。那么Spring Cloud Netflix有哪些组件(技术栈)呢，如下：<ul>
<li>Eureka：提供服务注册与发现功能；</li>
<li>Ribbon：提供负载均衡功能；</li>
<li>Feign：整合了ribbon和Hystrix，具有负载均衡和熔断限流等功能；</li>
<li>Hystrix：提供了熔断限流，合并请求等功能；</li>
<li>Zuul：提供了智能路由的功能；</li>
<li>Hystrix Dashboard：提供了服务监控的功能，提供了数据监控和友好的图形化界面；</li>
<li>Hystrix Turbine：Hystrix Turbine将每个服务Hystrix Dashboard数据进行了整合，也是监控系统的功能；</li>
<li>Spring Cloud Config：提供了统一配置的功能；</li>
<li>Spring Cloud Bus：提供了配置实时更新的功能；</li>
<li>….等等。<strong><code>注意：需要注意的是这些组件并不是一体化的，比如你完全可以用携程的Apollo来替换Spring Cloud config、也可以用NCOS或者Zookeeper来替换Eureka。</code></strong></li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>SpringCloud与SpringBoot的关系：</p>
<ul>
<li><p>SpringCloud是一个基于SpringBoot实现的云应用开发工具。Spring boot专注于快速、方便的集成单个微服务，Spring Cloud是关注全局的服务治理框架。spring boot使用了默认大于配置的理念，很多集成方案已经帮你选择好了，能不配置就不配置，Spring Cloud很大的一部分是基于Spring boot来实现。Spring Cloud与Spring Boot的版本关系如下所示。</p>
<p><img src="./Image-spc1.png" srcset="/img/loading.gif" alt="Image"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="Lesson2-微服务基础"><a href="#Lesson2-微服务基础" class="headerlink" title="Lesson2 微服务基础"></a>Lesson2 微服务基础</h2><h3 id="NO2-1-搭建基本微服务模块"><a href="#NO2-1-搭建基本微服务模块" class="headerlink" title="NO2.1 搭建基本微服务模块"></a>NO2.1 搭建基本微服务模块</h3><p>首先我们要知道一个微服务模块是如何搭建的。</p>
<ul>
<li><p><code>&lt;dependencyManagement&gt;和&lt;dependencies&gt;</code>的区别：</p>
<ul>
<li><p><code>&lt;dependencies&gt;</code>标签里放的是你要引入的依赖，所有声明在该标签里的依赖都会自动引入，并默认被所有的子项目继承；</p>
</li>
<li><p><code>&lt;dependencyManagement&gt;</code>标签只出现在父项目中；该标签管理一些依赖的版本号，子项目继承父项目后，就不用再写依赖的版本号了；该标签并不引入依赖，只是便于让子项目继承，然后子项目自己引入依赖。</p>
<pre><code class="hljs xml">//父工程中的mysql依赖

<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

-------------------------------------------------------------

//继承了父项目的子项目，引入了父项目定义过的依赖，那么就可以不用写version信息，因为父项目里已经定义好了；如果子项目想要使用别的版本号，也可以自己添加version信息进行指定即可
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>创建MyCloud父项目和cloud-provider-eureka-payment8001子项目。</p>
<ul>
<li><p>使用IDEA快速创建一个父项目，自定义项目名和包名即可；</p>
<p><img src="./Image-spc2.png" srcset="/img/loading.gif" alt="Image"></p>
</li>
<li><p>在父项目上，右键创建我们即将要做的provider-payment子项目。</p>
<p><img src="./Image-spc3.png" srcset="/img/loading.gif" alt="Image"></p>
</li>
<li><p>子项目创建完成后，在pom.xml中引入需要的使用的依赖；<strong><code>注意：actuator依赖用于监控Spring Boot应用本身的一些系统状态；</code></strong></p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>MyCloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dyf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!--Web依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--监控依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--MyBatis依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--Druid连接池依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--mysql-connector-java依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--JDBC依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--热部署依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--lombok依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--Test依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre>
</li>
<li><p>配置application.yml文件；</p>
<pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-payment-service</span>


  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment">#数据源类型</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>

    <span class="hljs-comment">#mysql驱动类</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/db2019?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">Deng521314</span>


<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">cn.dyf.entities</span></code></pre>
</li>
<li><p>配置主启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaPayment8001</span> </span>&#123;

   <span class="hljs-comment">//main方法</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
      SpringApplication.run(PaymentMain<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
   &#125;
&#125;</code></pre>
</li>
<li><p>创建数据库和表；</p>
<pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`payment`</span>(

  <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'id'</span>,
  <span class="hljs-string">`serial`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,
  PRIMARY <span class="hljs-keyword">KEY</span>(<span class="hljs-string">`id`</span>)

)<span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT = <span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8</code></pre>
</li>
<li><p>创建entities实体类和CommonResult信息类；</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">* <span class="hljs-doctag">@description</span>: 支付实体类</span>
<span class="hljs-comment">* <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment">* <span class="hljs-doctag">@date</span>: 2020-05-12 21:11</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Data</span>  
<span class="hljs-meta">@NoArgsConstructor</span>  <span class="hljs-comment">//无参构造</span>
<span class="hljs-meta">@AllArgsConstructor</span>  <span class="hljs-comment">//全参构造</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Payment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;

   <span class="hljs-keyword">private</span> Long id;
   <span class="hljs-keyword">private</span> String serial;
&#125;

<span class="hljs-comment">//---------------------------------------------------</span>

<span class="hljs-comment">/**</span>
<span class="hljs-comment">* <span class="hljs-doctag">@description</span>: 返回给前端的信息类</span>
<span class="hljs-comment">* <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment">* <span class="hljs-doctag">@date</span>: 2020-05-12 21:15</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonResult</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;

   <span class="hljs-keyword">private</span> Integer code;
   <span class="hljs-keyword">private</span> String message;
   <span class="hljs-keyword">private</span> T data;

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CommonResult</span><span class="hljs-params">(Integer code, String message, T data)</span> </span>&#123;
      <span class="hljs-keyword">this</span>.code = code;
      <span class="hljs-keyword">this</span>.message = message;
      <span class="hljs-keyword">this</span>.data = data;
   &#125;

   <span class="hljs-comment">//当获取数据失败时，需要调用的构造方法</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CommonResult</span><span class="hljs-params">(Integer code, String message)</span></span>&#123;
      <span class="hljs-keyword">this</span>(code,message,<span class="hljs-keyword">null</span>);
   &#125;
&#125;</code></pre>
</li>
<li><p>编写PaymentDao和PaymentDao.xml文件；</p>
<pre><code class="hljs xml">/**
* @description: 支付模块的Dao层
* @auther: 带头大哥杰尼龟
* @date: 2020-05-12 21:32
*/
@Mapper  //该注解会给当前类生成相应的实现类，所以该类下不允许方法重载
public interface PaymentDao &#123;

   //添加
   public int create(Payment payment);

   //查找
   public Payment getPaymentById(@Param("id") Long id);
&#125;

//--------------------------------

<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"cn.dyf.springcloud.dao.PaymentDao"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"cn.dyf.springcloud.entities.Payment"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"serial"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"serial"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"create"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"Payment"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        insert into payment(serial) values(#&#123;serial&#125;)
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getPaymentById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"Long"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        select id,serial from payment where id = #&#123;id&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre>
</li>
<li><p>编写PaymentService、PaymentServiceImpl、PaymentController文件；</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">* <span class="hljs-doctag">@description</span>: 支付模块的Service接口</span>
<span class="hljs-comment">* <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment">* <span class="hljs-doctag">@date</span>: 2020-05-12 22:11</span>
<span class="hljs-comment">*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PaymentService</span> </span>&#123;

   <span class="hljs-comment">//添加</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">create</span><span class="hljs-params">(Payment payment)</span></span>;

   <span class="hljs-comment">//查找</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Payment <span class="hljs-title">getPaymentById</span><span class="hljs-params">(@Param(<span class="hljs-string">"id"</span>)</span> Long id)</span>;
&#125;

<span class="hljs-comment">//-------------------------------------</span>

<span class="hljs-comment">/**</span>
<span class="hljs-comment">* <span class="hljs-doctag">@description</span>: 支付模块的Service实现类</span>
<span class="hljs-comment">* <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment">* <span class="hljs-doctag">@date</span>: 2020-05-12 22:13</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PaymentService</span> </span>&#123;

   <span class="hljs-meta">@Resource</span>
   <span class="hljs-keyword">private</span> PaymentDao paymentDao;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">create</span><span class="hljs-params">(Payment payment)</span> </span>&#123;
      <span class="hljs-keyword">return</span> paymentDao.create(payment);
   &#125;

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Payment <span class="hljs-title">getPaymentById</span><span class="hljs-params">(Long id)</span> </span>&#123;
      <span class="hljs-keyword">return</span> paymentDao.getPaymentById(id);
   &#125;
&#125;

<span class="hljs-comment">//--------------------------------------------</span>

<span class="hljs-comment">/**</span>
<span class="hljs-comment">* <span class="hljs-doctag">@description</span>: 支付模块的Controller层</span>
<span class="hljs-comment">* <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment">* <span class="hljs-doctag">@date</span>: 2020-05-12 22:18</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentController</span> </span>&#123;

   <span class="hljs-meta">@Resource</span>
   <span class="hljs-keyword">private</span> PaymentService paymentService;

   <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/payment/create"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">create</span><span class="hljs-params">(Payment payment)</span></span>&#123;

      <span class="hljs-comment">//添加</span>
      <span class="hljs-keyword">int</span> result = paymentService.create(payment);

      <span class="hljs-comment">//日志记录</span>
      log.info(<span class="hljs-string">"****添加结果："</span>+result);

      <span class="hljs-keyword">if</span>(result &gt; <span class="hljs-number">0</span> )&#123;

         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"添加成功"</span>,result);
      &#125;<span class="hljs-keyword">else</span>&#123;

         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">500</span>,<span class="hljs-string">"添加失败"</span>,<span class="hljs-keyword">null</span>);
      &#125;
   &#125;


   <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/payment/get/&#123;id&#125;"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">create</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)</span>&#123;

      <span class="hljs-comment">//查询</span>
      Payment payment = paymentService.getPaymentById(id);

      <span class="hljs-comment">//日志记录</span>
      log.info(<span class="hljs-string">"****添加结果："</span> + payment);

      <span class="hljs-keyword">if</span>(payment != <span class="hljs-keyword">null</span> )&#123;

         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"查询成功"</span>,payment);
      &#125;<span class="hljs-keyword">else</span>&#123;
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">500</span>,<span class="hljs-string">"查询失败，要查询的id为："</span> + id, <span class="hljs-keyword">null</span>);
      &#125;
   &#125;
&#125;</code></pre>
</li>
<li><p>运行我们编写的微服务，测试两个方法即可。</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>因为我们常常会修改项目，所以总是启动和关闭项目很耗费资源，于是我们经常使用到热部署(该依赖一般只用在开发阶段)：</p>
<ul>
<li><p>引入热部署依赖到指定项目的pom.xml文件中；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--热部署依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>添加到插件依赖到父工程的pom.xml中；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fork</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">fork</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">addResources</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addResources</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

<span class="hljs-comment">&lt;!--注意：上面的plugin标签要放在plugins标签中--&gt;</span></code></pre>
</li>
<li><p>设置一下IDEA的一些设置，即下面红框中的四个选项都要勾选；</p>
<p><img src="./Image-spc4.png" srcset="/img/loading.gif" alt="image-20200715135113312"></p>
</li>
<li><p>进入导入了热部署依赖的pom.xml文件中，使用快捷键<code>shift+control+clt+/</code>，出现如下图2.1.1示的对话框后，点击Registry，在出现后的图2.1.2示的对话框中找到对应的两个选项勾选；</p>
<p><img src="./Image-spc5.png" srcset="/img/loading.gif" alt="image-20200715135405703"></p>
<p><code>说明：图2.1.1</code></p>
<p><img src="./Image-spc6.png" srcset="/img/loading.gif" alt="image-20200715135953499"></p>
<p><code>说明：图2.1.2</code></p>
</li>
<li><p>重启IDEA，到此热部署配置完成。</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>创建cloud-consumer-eureka-order8100子项目(以下简称8100子项目)，步骤和创建cloud-provider-eureka-payment8001子项目(以下简称8001子项目)一样，这里不过多叙述；但是8100子项目中，因为要调用8001子项目的功能，所以这里就涉及到了微服务之间的调用；</p>
<ul>
<li><p>RestTemplate：</p>
<ul>
<li>定义：RestTemplate是Spring提供的用于访问Rest服务(这个其实就是访问其它的微服务)的客户端，RestTemplate提供了多种便捷访问远程Http服务的方法,能够大大提高客户端的编写效率。<code>简单讲，RestTemplate这个东西就是用来访问其它微服务而使用的一个客户端</code>；</li>
</ul>
</li>
<li><p>首先，创建一个配置类，将RestTemplate对象交给Spring管理；</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2020-07-15 14:34</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationContextConfig</span> </span>&#123;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRestTemplate</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();
	&#125;

&#125;</code></pre>
</li>
<li><p>编写80子项目的Controller类调用8001子项目的微服务即可；</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2020-07-15 14:26</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PAYMENT_URL=<span class="hljs-string">"http://localhost:8001"</span>;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> RestTemplate restTemplate;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/comsumer/create"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">create</span><span class="hljs-params">(Payment payment)</span></span>&#123;

		<span class="hljs-keyword">return</span> restTemplate.postForObject(PAYMENT_URL+<span class="hljs-string">"/payment/create"</span>,payment,CommonResult<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/comsumer/get/&#123;id&#125;"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">getPayment</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)</span>&#123;

		<span class="hljs-keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="hljs-string">"/payment/get/"</span>+id,CommonResult<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;

&#125;

<span class="hljs-comment">//----------------------------------------------------</span>

<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/payment/create"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">create</span><span class="hljs-params">(@RequestBody Payment payment)</span></span>&#123;

    <span class="hljs-comment">//添加</span>
    <span class="hljs-keyword">int</span> result = paymentService.create(payment);

    <span class="hljs-comment">//日志记录</span>
    log.info(<span class="hljs-string">"****添加结果："</span>+result);

    <span class="hljs-keyword">if</span>(result &gt; <span class="hljs-number">0</span> )&#123;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"添加成功"</span>,result);
    &#125;<span class="hljs-keyword">else</span>&#123;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">500</span>,<span class="hljs-string">"添加失败"</span>,<span class="hljs-keyword">null</span>);
    &#125;
&#125;

注意：在使用<span class="hljs-number">80</span>子项目来调用<span class="hljs-number">8001</span>子项目(这就是微服务之间的调用)时，会发现添加数据时，没有添加进去，这是因为在微服务之间的调用，对象类型的参数被转化成JSON数据然后进行http传输调用，所以在后续的微服务中要获得前面微服务传来的对象类型参数时，要使用注解<span class="hljs-meta">@RequestBody</span>来封装获取到的对象类型参数</code></pre>
</li>
<li><p>最后，测试微服务之间的调用即可。<strong><code>注意：一般启动多个微服务，会自动出现rundashboard这个节目，便于微服务的查看，如果没有，请按照以下步骤操作。</code></strong></p>
<ul>
<li><p>右键父工程，找到show in explorer选项，该步骤其实就是打开你项目的本地路径，找到<code>.idea</code>目录，进入后，找到<code>workspace.xml</code>文件并打开，然后添加如下代码到该文件的指定位置；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"configurationTypes"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"SpringBootApplicationConfigurationType"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>

说明：将上面这段代码添加到<span class="hljs-tag">&lt;<span class="hljs-name">componment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"RunDashboard"</span>&gt;</span>标签中，重启IDEA即可</code></pre>

<p><img src="./Image-spc7.png" srcset="/img/loading.gif" alt="image-20200715154414307"></p>
</li>
<li><p>重启IDEA接即可。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>测试完成后，发现上述两个子项目可以完成微服务之间的调用了，但是两个子项目中都有entites这个实体类，所以我们要将这个重复的实体类抽取出来让大家共用，所以需要对工程进行一次重构；</p>
<ul>
<li><p>首先创建一个子项目cloud-api-commons并修改pom.xml文件，该项目就是存放那些复用较高的代码。说白了就是将这些复用的代码打包成一个JAR包，在各个子项目中只要引入依赖就可以使用了；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--添加如下依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>使用Maven的生命周期clean，再使用install将项目打包成JAR包上传到本地仓库中；</p>
</li>
<li><p>在各个子项目中引入自定义的JAR依赖；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dyf.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> 

注意：如果IDEA提示说找不到本地的这个JAR包，那么可以把<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>标签去掉试一试</code></pre>
</li>
<li><p>最后，打开项目，测试运行微服务的访问；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-2-Eureka–服务注册中心"><a href="#NO2-2-Eureka–服务注册中心" class="headerlink" title="NO2.2 Eureka–服务注册中心"></a>NO2.2 Eureka–服务注册中心</h3><ul>
<li>Eureka：<ul>
<li>定义：即SpringCloud Netflix框架中的Eureka模块，主要用来实现服务治理；</li>
<li>作用：管理服务与服务之间的依赖关系，可以实现服务调用、负载均衡、容错、服务发现与注册等等；</li>
<li>组件：<ul>
<li><code>Eureka Server</code>：提供服务注册功能。即各个微服务节点通过配置启动后，会在Eureka Server中进行注册，这样Eureka Server中的服务注册表将会存储所有可用服务节点的信息，服务节点的信息可以在界面直观看到；</li>
<li><code>Eureka Client</code>：通过注册中心进行访问。这是一个Java客户端，用于简化和Eureka Server的交互，客户端同时也具备一个内置的、使用轮询负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心疼(默认周期为30秒)。如果Eureka Server在多个心跳周期内(默认90秒)没有接收到某个节点的心跳，Eureka Server将会从服务注册中把该服务节点移除。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>单点Eureka Server的配置：</p>
<ul>
<li><p>创建一个cloud-server-eureka7001项目(以下简称7001子项目)，导入依赖：</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Eureka服务端 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dyf.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!--Web依赖--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 一般通用配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>编写application.yml配置文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">7001</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-comment">#eureka服务端的实例名字</span>

  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#表示不向注册中心注册自己</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span>
    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#设置与eureka server交互的地址，查询服务和注册服务都需要依赖这个地址，也就是说，当前项目是微服务的话，那么这里放的就是你要注册进的服务注册中心的地址；如果当前项目是服务注册中心，你打算进行进群配置，那么这里放的就是其他服务注册中心的地址</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></code></pre>
</li>
<li><p>编写Eureka Server的启动类；</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2020-07-16 14:26</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaServer</span>  <span class="hljs-comment">//告诉Spring这是服务注册中心，并开启该服务</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaMain7001</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaMain7001<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>启动7001子项目，并输入<code>http://localhost:7001</code>就可以访问eureka服务注册中心了；</p>
<p><img src="./Image-spc8.png" srcset="/img/loading.gif" alt="image-20200716143709914"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>将8001子项目注册到Eureka服务注册中心：</p>
<ul>
<li><p>导入Eureka客户端依赖到8001子项目；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Eureka客户端 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>修改8001子项目的配置文件，并配置Eureka客户端信息；</p>
<pre><code class="hljs yml"><span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#是否把自己注册进Eukreka服务注册中心</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment">#表示是否从Eureka服务注册中心获取注册信息，默认为true。单节点无所谓，但是集群则必须设置为true才能配合Ribbon使用负载均衡</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:7001/eureka</span></code></pre>
</li>
<li><p>在8001子项目的启动类上添加注解：</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>  <span class="hljs-comment">//告诉Spring，我是Eureka客户端</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentMain</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(PaymentMain<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>访问Eureka，查看8001子项目的服务是否成功注册到Eureka中；</p>
<p><img src="./Image-spc9.png" srcset="/img/loading.gif" alt="image-20200716145705332"></p>
</li>
<li><p>最后，将8100子项目也注册到Eureka中，步骤参照8001子项目即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Eureka集群：</p>
<ul>
<li><p>介绍：如果我们的服务注册中心只有一个，万一哪天出故障了，那么所有服务都将无法使用，所以为了避免这种情况发生，就出现了集群，简单讲，就是多预备几个服务注册中心就可以了；</p>
</li>
<li><p>原理：其实就是Eureka Server之间相互注册；</p>
</li>
<li><p>基本步骤：</p>
<ul>
<li><p>创建cloud-server-eureka7002子项目(以下简称7002子项目)，该子项目就是用于Eureka集群配置，导入依赖，和7001子项目中的依赖相同即可；</p>
</li>
<li><p>如果你是本机上测试Eureka集群，那么需要到本机的<code>C:\Windows\System32\drivers\etc</code>下找到并编辑hosts文件；</p>
<pre><code class="hljs txt">#集群配置
127.0.0.1  eureka7001.com
127.0.0.1  eureka7002.com

说明：表示，当访问域名为eureka7001.com时，实际访问的是127.0.0.1，访问eureka7002.com同理。</code></pre>
</li>
<li><p>分别修改Eureka的集群配置文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">7001</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">eureka7001.com</span>
    <span class="hljs-comment">#eureka服务端的实例名字</span>

  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#表示不向注册中心注册自己</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span>
    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#设置与eureka server交互的地址，查询服务和注册服务都需要依赖这个地址</span>
      <span class="hljs-comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span>
      <span class="hljs-comment">#@defaultZone: http://eureka7002.com:7002/eureka/,....</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7002.com:7002/eureka/</span>

<span class="hljs-string">//---------------------------------------------------</span>

<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">7002</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">eureka7002.com</span>
    <span class="hljs-comment">#eureka服务端的实例名字</span>

  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#表示不向注册中心注册自己</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span>
    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#设置与eureka server交互的地址，查询服务和注册服务都需要依赖这个地址</span>
      <span class="hljs-comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span></code></pre>
</li>
<li><p>配置7002子项目启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaMain7002</span> </span>&#123;
    <span class="hljs-comment">//main方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

        SpringApplication.run(EurekaMain7002<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;
&#125;</code></pre>
</li>
<li><p>启动Eureka集群并访问Eureka进行测试；</p>
<p><img src="./Image-spc10.png" srcset="/img/loading.gif" alt="image-20200716154814682"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>将8100子项目、8001子项目注册到Eureka集群中。</p>
<ul>
<li><p>分别修改两个子项目的yml配置文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">service-url:</span>
  <span class="hljs-comment">#这是单个Eureka的配置</span>
  <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span>

  <span class="hljs-comment">#这是集群Eureka的配置</span>
  <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span>
      
<span class="hljs-string">说明：其实只要将两个子项目的service-url配置一下就可以了，也就是将微服务同时注册进多个Eureka就行了</span></code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>将多个微服务提供者注册到服务注册中心，并在调用微服务时，默认使用轮询调度的方式去调用相同的微服务。</p>
<ul>
<li><p>创建cloud-provider-eureka-payment8002子项目(以下简称8002子项目)，该项目和8001子项目一样，是微服务的提供者，所以创建过程和8001子项目一致，参考8001子项目即可；</p>
</li>
<li><p>配置调用者8100子项目，由于我们要调用的微服务，现在有两个了，即8001子项目和8002子项目，那么我们现在访问微服务时，不能写死指定去访问某一个微服务，这样就达不到轮询调度微服务的效果；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-comment">//public static final String PAYMENT_URL="http://localhost:8001";</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PAYMENT_URL=<span class="hljs-string">"http://CLOUD-PAYMENT-SERVICE"</span>;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> RestTemplate restTemplate;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/comsumer/create"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">create</span><span class="hljs-params">(Payment payment)</span></span>&#123;

		<span class="hljs-keyword">return</span> restTemplate.postForObject(PAYMENT_URL+<span class="hljs-string">"/payment/create"</span>,payment, CommonResult<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/comsumer/get/&#123;id&#125;"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">getPayment</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)</span>&#123;

		<span class="hljs-keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="hljs-string">"/payment/get/"</span>+id,CommonResult<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;

&#125;

说明：因为将<span class="hljs-number">8001</span>和<span class="hljs-number">8002</span>两个子项目都注册到了Eureka，此时再去访问<span class="hljs-number">8100</span>子项目，却发现项目报错，原因是，服务注册中心不知道你要用什么方式调用微服务，因为微服务提供者有两个，所以还需要对RestTemplate进行配置，即让该对象使用轮询调度方式去访问
    
    
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationContextConfig</span> </span>&#123;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-meta">@LoadBalanced</span>  <span class="hljs-comment">//该注解就是让访问达到负载均衡的效果，即轮询调度相同服务名下的不同微服务实体</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRestTemplate</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();
	&#125;

&#125;</code></pre>
</li>
<li><p>配置完成后，测试调用微服务。</p>
<p><img src="./Image-spc11.png" srcset="/img/loading.gif" alt="image-20200717120731367"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>actuator微服务信息完善：</p>
<ul>
<li><p>集群微服务中服务名称的修改，及显示微服务的ip地址：只需要分别在不同的微服务提供者项目的yml文件中进行配置即可。</p>
<pre><code class="hljs yml"><span class="hljs-comment">#....省略了前面的一些其他配置详情</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#是否把自己注册进Eukreka服务注册中心</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment">#表示是否从Eureka服务注册中心获取注册信息，默认为true。单节点无所谓，但是集群则必须设置为true才能配合Ribbon使用负载均衡</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#这是单个Eureka的配置</span>
      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span>

      <span class="hljs-comment">#这是集群Eureka的配置</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span>

  <span class="hljs-comment">#这个就是配置服务提供者的服务名称，以及显示ip地址</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">payment8002</span>
    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span>
    
<span class="hljs-string">注意：服务注册中心里的微服务名称就是ServiceId，而这里配置的instance-id则是该微服务项目不同的服务实例，不要搞混了。</span></code></pre>

<p><img src="./Image-spc12.png" srcset="/img/loading.gif" alt="image-20200717133036671"></p>
<p><img src="./Image-spc13.png" srcset="/img/loading.gif" alt="image-20200717133448212"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>服务发现Discover：即我想要知道Eurake上有哪些微服务可以使用，然后还可以根据指定的微服务名称，查看该微服务下更详细的微服务信息，这就是服务发现；代码如下：</p>
<ul>
<li><p>首先，我们需要一个DiscoveryClient服务发现对象，其实个人理解，这个对象就相当于是Eureka的实例对象一样，能够获得Eureka中有哪些微服务，以及查看更加具体的微服务信息等待；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;  <span class="hljs-comment">//这里的服务发现对象是org.springframework.cloud.client.discovery.DiscoveryClient包的，别导错包了</span>


<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/payment/diss"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;

    List&lt;String&gt; services = discoveryClient.getServices();

    <span class="hljs-keyword">for</span> (String s:services) &#123;
        <span class="hljs-comment">//输出</span>
        System.out.println(<span class="hljs-string">"拥有服务："</span>+s);
    &#125;

    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">"CLOUD-PAYMENT-SERVICE"</span>);
    
    <span class="hljs-keyword">for</span>(ServiceInstance si:instances)&#123;
        <span class="hljs-comment">//输出</span>
        System.out.println(si.getServiceId()+<span class="hljs-string">"---"</span>
         +si.getInstanceId()+<span class="hljs-string">"---"</span>
         +si.getHost()+<span class="hljs-string">"---"</span>
         +si.getPort()+<span class="hljs-string">"---"</span>
         +si.getUri());
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-string">"Ok"</span>;

&#125;

说明：
一、这个getMessage查询方法，你想要放到哪个子项目都行，我这里是放到了<span class="hljs-number">80</span>子项目中的controller里；
    
二、方法解析：
    <span class="hljs-number">1</span>.getServices()方法，是获取服务注册中心里所有的微服务名称；
    <span class="hljs-number">2</span>.getInstances(String ServiceId)方法，是获取某个指定微服务名称的实例对象，一般会有多个，也可能只有一个；
    <span class="hljs-number">3</span>.getInstanceId()方法，获取指定微服务下，当前实例的InstanceId。你可以理解为，实际提供这种微服务的有哪些电脑机器在运行，而这个InstanceId就是这台机器的一个名称而已；
    <span class="hljs-number">4</span>.getHost()方法，获取微服务下运行实例的ip地址；
    <span class="hljs-number">5</span>.getPort()方法，获取微服务下运行实例的端口号；
    <span class="hljs-number">6</span>.getUri()方法，获取微服务下运行实例的访问uri；
    <span class="hljs-number">7</span>.getServiceId()方法，获取当前运行实例所属的微服务的服务名称。</code></pre>
</li>
<li><p>其次，需要在8100子项目的启动类上，添加注解@EnableDiscoveryClient，该注解的作用是让服务注册中心能够发现该服务；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>  <span class="hljs-comment">//让服务注册中心能够发现该服务</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentMain</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(PaymentMain<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;

说明：
一、<span class="hljs-meta">@EnableEurekaClient</span>和<span class="hljs-meta">@EnableDiscoveryClient</span>两个注解的作用都是让服务注册中心发现该服务；
    
二、<span class="hljs-meta">@EnableEurekaClient</span>只用于Eureka服务注册中心；<span class="hljs-meta">@EnableDiscoveryClient</span>除了Eureka，还可用于其他服务注册中心。</code></pre>
</li>
<li><p>最后，运行微服务测试即可。</p>
<p><img src="./Image-spc14.png" srcset="/img/loading.gif" alt="image-20200717144239462"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>自我保护：</p>
<ul>
<li><p>定义：出现自我保护的意思是指，当某一时刻某一个微服务不可用了，那么Eureka也不会立刻清理，依旧会对该微服务的信息进行保存；一般用于Eureka客户端和服务端进行通信时，网络波动、故障等等导致的心跳机制没反应，那么此时服务注册中心并不会清理没有收到心跳的这些微服务，即不盲目删除可能的健康微服务，从而保证了Eureka的健壮性，所以默认自我保护是开启的。这属于CAP里面的AP分支；</p>
</li>
<li><p>关闭自我保护：</p>
<ul>
<li><p>配置7001子项目(该项目就是Eureka服务注册中心)的yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">7001</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">eureka7001.com</span>
    <span class="hljs-comment">#eureka服务端的实例名字</span>

  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#表示不向注册中心注册自己</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span>
    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#设置与eureka server交互的地址，查询服务和注册服务都需要依赖这个地址</span>
      <span class="hljs-comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7002.com:7002/eureka/</span>
  <span class="hljs-attr">server:</span>
    <span class="hljs-comment">#关闭自我保护机制，也就是当收不到微服务的心跳时，就及时清理掉改为服务的信息</span>
    <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">#清理无效节点的时间间隔，默认60000毫秒，即60秒</span>
    <span class="hljs-attr">eviction-interval-timer-in-ms:</span> <span class="hljs-number">2000</span></code></pre>
</li>
<li><p>配置8100子项目的心跳时间和心跳超时时间；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8100</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-order-service</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#是否把自己注册进Eukreka服务注册中心</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment">#表示是否从Eureka服务注册中心获取注册信息，默认为true。单节点无所谓，但是集群则必须设置为true才能配合Ribbon使用负载均衡</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#这是单个Eureka的配置</span>
      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span>

      <span class="hljs-comment">#这是集群Eureka的配置</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-comment">#表示Eureka client发送心跳给server端的频率，即每多少秒发送心跳给服务注册中心，默认30秒</span>
    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">15</span>
    <span class="hljs-comment">#心跳超时等待时间，即如果服务注册中心超过指定时间没有收到微服务的心跳，那么就清理改为服务的注册信息，默认是90秒</span>
    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">20</span></code></pre>
</li>
<li><p>最后，开启Eureka和微服务测试即可。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-3-ZooKeeper–服务注册中心"><a href="#NO2-3-ZooKeeper–服务注册中心" class="headerlink" title="NO2.3 ZooKeeper–服务注册中心"></a>NO2.3 ZooKeeper–服务注册中心</h3><p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-4-Consul–服务注册中心"><a href="#NO2-4-Consul–服务注册中心" class="headerlink" title="NO2.4 Consul–服务注册中心"></a>NO2.4 Consul–服务注册中心</h3><p>Consul也是作为Eureka闭源之后的选择之一。</p>
<ul>
<li><p>Consul：</p>
<ul>
<li><p>介绍：是一套开源的分布式服务发现和配置管理系统，由HashiCorp公司用Go语言开发；</p>
</li>
<li><p>功能：</p>
<ul>
<li>服务发现；</li>
<li>健康监测；</li>
<li>KV存储，即Key、Value的存储方式；</li>
<li>多数据中心；</li>
<li>可视化Web节目等等；</li>
</ul>
</li>
<li><p>安装与配置：</p>
<ul>
<li><p>首先，从官网下载自己想要的版本即可；</p>
</li>
<li><p>下载完成后，解压后只有一个<code>consul.exe</code>文件，将该文件放到自定义的目录下即可；</p>
</li>
<li><p>进入consul.exe文件所在目录，打开cmd后，输入：<code>consul</code>，即可安装consul，安装成功后会出现如下；</p>
<p><img src="./Image-spc15.png" srcset="/img/loading.gif" alt="image-20200717175213423"></p>
</li>
<li><p>安装完成后，启动consul，输入命令：<code>consul agent -dev</code>；成功启动后，可以通过地址：<code>http://localhost:8500/</code>查看consul的节目。</p>
<p><img src="./Image-spc16.png" srcset="/img/loading.gif" alt="image-20200717175633849"></p>
<p><img src="./Image-spc17.png" srcset="/img/loading.gif" alt="image-20200717175849257"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>服务提供者注册进Consul：</p>
<ul>
<li><p>创建cloud-provider-consul-payment8003子项目(以下简称8003子项目)，并引入Consul依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引用自己定义的api通用包 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--SpringCloud consul-server--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8003</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">consul-provider-payment</span>

  <span class="hljs-comment">#服务注册中心地址配置</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">consul:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8500</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">service-name:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsulPayment8004</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(ConsulPayment8004<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;

	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayController</span> </span>&#123;

	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;server.port&#125;"</span>)
	<span class="hljs-keyword">private</span> String port;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consul/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-comment">//输出</span>
		System.out.println(<span class="hljs-string">"这里运行的是consul，端口号为："</span>+port);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>运行微服务，查看<code>localhost:8500</code>是否有我们的微服务注册进Consul中；</p>
<p><img src="./Image-spc18.png" srcset="/img/loading.gif" alt="image-20200717185405246"></p>
</li>
<li><p>最后，把服务消费者也注册进Consul，步骤和上面差不多，就不过多叙述了，不过由于是定义的消费者，那么也就需要调用其他微服务；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationContextConfig</span> </span>&#123;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-meta">@LoadBalanced</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRestTemplate</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();
	&#125;
&#125;

<span class="hljs-comment">//-------------------------------------------</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PAYMENT_URL=<span class="hljs-string">"http://consul-provider-payment"</span>;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> RestTemplate restTemplate;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consul/get"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPayment</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="hljs-string">"/consul/payment"</span>,String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;

&#125;</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>三个服务注册中心的异同点：</p>
<p><img src="./Image-spc19.png" srcset="/img/loading.gif" alt="image-20200718131455680"></p>
<ul>
<li>CAP理论：<ul>
<li><code>C</code>：Consistency，即强一致性，分布式节点之间的数据或者状态应该保持一致。<code>如，服务注册中间件中注册服务列表应该保持一致</code>；</li>
<li><code>A</code>：Availability，即可用性，在集群中一部分节点故障后，集群整体仍然能正常响应客户端的读写请求；</li>
<li><code>P</code>：Partition tolerance，即分区容错性，分区容错的意思是，区间通信可能失败；分布式系统在遇到部分网络故障的情况下(该情况下，一般两台机器是收不到互相发送的信息)，仍然能都对外提供满足一致性和可用性的服务。<code>如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信</code>。</li>
</ul>
</li>
<li>CAP三个特性只能满足其中两个，那么取舍的策略就共有三种：<ul>
<li><code>获取CA，放弃P</code>：如果不要求P(不允许分区)，则C(强一致性)和A(可用性)是可以保证的。但放弃P的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的。</li>
<li><code>获取CP，放弃A</code>：如果不要求A(可用)，相当于每个请求都需要在服务器之间保持强一致，而P(分区)会导致同步时间无限延长(也就是等待数据同步完才能正常访问服务)，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统。设计成CP的系统其实不少，最典型的就是分布式数据库，如Redis、HBase等。对于这些分布式数据库来说，数据的一致性是最基本的要求，因为如果连这个标准都达不到，那么直接采用关系型数据库就好，没必要再浪费资源来部署分布式数据库。</li>
<li><code>获取AP，放弃C</code>：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。典型的应用就如某米的抢购手机场景，可能前几秒你浏览商品的时候页面提示是有库存的，当你选择完商品准备下单的时候，系统提示你下单失败，商品已售完。这其实就是先在 A(可用性)方面保证系统可以正常的服务，然后在数据的一致性方面做了些牺牲，虽然多少会影响一些用户体验，但也不至于造成用户购物流程的严重阻塞。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-5-Ribbon–负载均衡"><a href="#NO2-5-Ribbon–负载均衡" class="headerlink" title="NO2.5 Ribbon–负载均衡"></a>NO2.5 Ribbon–负载均衡</h3><ul>
<li>Ribbon：<ul>
<li>介绍：Spring Cloud Ribbon是一个基于Netflix Ribbon实现的客户端负载均衡工具；</li>
<li>功能：主要提供客户端的软件负载均衡算法和服务调用，将Netflix的中间层服务连接在一起；简单的说，就是在配置文件中列出Load Balancer(简称LB)后面所有的机器，Ribbon会自动的帮助你基于某种规则(如，简单轮询、随机连接等)去连接这些机器；</li>
<li>负载均衡：<ul>
<li>定义：简单的说就是将用户的请求平摊的分配到多个服务上；常见的负载均衡有软件Nginx、LVS，硬件F5等。</li>
<li>分类：<ul>
<li><code>集中式LB</code>：即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件，像F5；也可以是软件，像nginx)，由该设施负责把访问请求通过某种策略转发至服务的提供方</li>
<li><code>进程内LB</code>：将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。Ribbon就属于进程内LB，它只是一个类库，集成于消费方进程中，消费方通过它来获取到服务提供方的地址；</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Ribbon依赖和RestTemplate模板：</p>
<ul>
<li><p>导入依赖；因为Eureka依赖中，已经集成了Ribbon的依赖，所以不需要单独另外引入Ribbon的依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>RestTemplate模板中的方法：</p>
<ul>
<li><p>GET请求：</p>
<ul>
<li>getForEntity()：参数按顺序一般是，要调用的服务的地址、希望返回的响应体信息类型；返回值是则一个<code>ResponseEntity&lt;T&gt;</code>，<code>ResponseEntity&lt;T&gt;</code>是Spring对HTTP请求响应的封装，包括了几个重要的元素，像什么响应码、contentType、contentLength、响应消息体等。可以通过返回值调用如下常用方法：<ul>
<li>getBody()：获取响应体消息；</li>
<li>getStatusCode()：获取响应码；</li>
<li>getStatusCodeValue()：获取响应码表示的对应信息；</li>
<li>getHeaders()：获取响应头信息；</li>
</ul>
</li>
<li>getForObject()：getForObject()方法实际上是对getForEntity函数的进一步封装，如果你只关注返回的消息体的内容，对其他信息都不关注，此时可以使用getForObject；</li>
</ul>
</li>
<li><p>POST请求：</p>
<ul>
<li>postForEntity()：参数按顺序一般是，要调用的服务的地址、要上传的参数、希望返回的数据的类型；返回值和getForEntity()描述一致，这里不过多叙述；</li>
<li>postForObject()：同样，只关注返回体消息类型，那么使用该方法即可；</li>
</ul>
</li>
<li><p>PUT请求：PUT请求可以通过put方法调用，put方法的参数和前面介绍的postForEntity方法的参数基本一致，只是put方法没有返回值而已；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/put"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">()</span> </span>&#123;

    Book book = <span class="hljs-keyword">new</span> Book();
    book.setName(<span class="hljs-string">"一千零一夜"</span>);
    
    restTemplate.put(<span class="hljs-string">"http://MY-SERVICE/get/&#123;1&#125;"</span>, book, <span class="hljs-number">2</span>);
&#125;</code></pre>
</li>
<li><p>DELETE请求：DELETE请求我们可以通过delete方法调用来实现；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/delete"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">()</span> </span>&#123;
    restTemplate.delete(<span class="hljs-string">"http://MY-SERVICE/get/&#123;1&#125;"</span>, <span class="hljs-number">100</span>);
&#125;</code></pre>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Ribbon负载均衡算法：</p>
<ul>
<li><p>介绍：因为Ribbon的负载均衡算法主要是实现IRule接口，该接口中的方法的最终目的就是选择负载均衡算法，所以该接口的实现类主要有以下几种：<strong><code>注意：Ribbon中没有指定负载均衡算法的话，则默认是轮询算法。</code></strong></p>
<p><img src="./Image-spc20.png" srcset="/img/loading.gif" alt="image-20200718154243735"></p>
</li>
<li><p>Ribbon负载均衡规则替换：</p>
<ul>
<li><p>首先要明白，想要替换Ribbon的负载均衡规则，那么需要创建一个配置类，但是该配置类不能放在@ComponentScan注解扫描的包及其子包下。换句话说，SpringBoot中有启动类吧，启动类的@SpringApplication注解中，就有@ComponentScan注解，所以，Ribbon负载均衡配置类不能放在SpringBoot的启动类所在的顶层包中，只能放在启动类的顶层包的再高一层包中；所以首先在消费方8000子项目中，创建配置类的包和配置类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySelfRule</span> </span>&#123;
	
	<span class="hljs-meta">@Bean</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> IRule <span class="hljs-title">myRule</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-comment">//使用随机算法</span>
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RandomRule();
	&#125;
&#125;</code></pre>

<p><img src="./Image-spc21.png" srcset="/img/loading.gif" alt="image-20200718155450942"></p>
</li>
<li><p>然后，在消费方的启动类上，添加@RibbonClient注解，该注解的作用就是告知Spring，我这个是Ribbon的客户端；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@RibbonClient</span>(name = <span class="hljs-string">"CLOUD-PAYMENT-SERVICE"</span>,configuration = MySelfRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">EurekaOrder8000</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaOrder8000<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;

说明：<span class="hljs-meta">@RibbonClient</span>注解中的name属性，表示喂喂要访问的微服务名称，configuration属性则是使用自己的配置类，即使用自定义的负载均衡算法。</code></pre>
</li>
<li><p>最后，启动Eureka测试随机算法是否生效即可；</p>
</li>
</ul>
</li>
<li><p>Ribbon负载均衡算法原理：<code>rest接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标</code>，要注意的是，每次服务重新启动后，rest接口计数从1开始；</p>
<pre><code class="hljs lsl">现在有一个Eureka服务注册中心在运行，这上面有一个微服务，但是该微服务下有两个实例，也就是有两台机器在跑这个微服务，访问哪个实例都可以。
那么此时，服务器集群总数量就是<span class="hljs-number">2</span>，因为有<span class="hljs-number">2</span>台服务器在跑这个微服务嘛，开启Eureka服务注册中心后，暂时没有任何访问，所以此时rest接口请求数为<span class="hljs-number">0</span>，如果来一次请求，那么就+<span class="hljs-number">1</span>。
假设，此时来了<span class="hljs-number">1</span>个请求，那么按照上面的公式，就可以知道<span class="hljs-number">1</span> % <span class="hljs-number">2</span> = <span class="hljs-number">1</span>，那么就去调用在集群中下标为<span class="hljs-number">1</span>的服务器去访问即可，那么怎么知道哪个是下标为<span class="hljs-number">1</span>的服务器呢，很简单，按照先后在Eureka中的注册顺序，把同一微服务下的所有实例放进一个<span class="hljs-type">list</span>中，顺序标记即可。每次服务重新启动后，rest接口计数从<span class="hljs-number">1</span>开始。</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-6-OpenFeign–服务接口调用"><a href="#NO2-6-OpenFeign–服务接口调用" class="headerlink" title="NO2.6 OpenFeign–服务接口调用"></a>NO2.6 OpenFeign–服务接口调用</h3><p>开发微服务，免不了需要服务间调用，其中Spring Cloud Netflix框架提供了RestTemplate和FeignClient两个方式完成服务间调用。</p>
<ul>
<li>OpenFeign：<ul>
<li>介绍：Feign是一种声明式、模板化的HTTP客户端。在Spring Cloud中使用的OpenFeign就是基于Feign，且在此基础上拓展了更多功能的升级版，可以做到使用HTTP请求访问远程服务，就像调用本地方法一样的，开发者完全感知不到这是在调用远程方法，更感知不到在访问HTTP请求。简单讲，OpenFeign就是添加接口和一些注解，你就可以轻松方便的调用其他的微服务了，即OpenFeign是用在消费端；</li>
<li>和Feign的区别：主要就是OpenFeign是Spring Cloud在Feign的基础上支持了Spring MVC的注解。<code>如@RequesMapping等等</code>；</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>OpenFeign使用基本步骤：</p>
<ul>
<li><p>创建cloud-consumer-eureka-openfeign-order8102子项目(以下简称8102子项目)，并导入依赖，依赖和8100子项目中的依赖差不多，只不过要多一个OpenFeign依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

注意：OpenFeign依赖中，其实已经包含了Ribbon依赖</code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8102</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka,</span> <span class="hljs-string">http://eureka7002.com:7002/eureka</span></code></pre>
</li>
<li><p>配置启动类，在启动类上添加@EnableFeignClients注解，该注解就是激活并启OpenFeign；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableFeignClients</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EureakOrder8102</span> </span>&#123;
    <span class="hljs-comment">//main方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

        SpringApplication.run(EureakOrder8102<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;</code></pre>
</li>
<li><p>配置OpenFeign的接口，即该接口充当消费者的service层，原本调用者是不需要service层；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"cloud-payment-service"</span>)  <span class="hljs-comment">//使用OpenFeign</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FeignService</span> </span>&#123;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/payment/get/&#123;id&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">getPayment</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)</span>;
&#125;
    

说明：<span class="hljs-meta">@FeignClient</span>就是使用OpenFeign，value属性就是要调用的微服务</code></pre>
</li>
<li><p>配置controller，其实就是在controller中调用上面配置的接口方法，也就是多了上面的接口处，把要访问的微服务信息封装到了上面；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> FeignService feignService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ofeign/get/&#123;id&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title">getPayment</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)</span>&#123;

        <span class="hljs-keyword">return</span> feignService.getPayment(id);
    &#125;</code></pre>
</li>
<li><p>最后启动8001和8002微服务、8102消费者、以及7001和7002两个Eureka注册中心进行测试即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>OpenFeign的响应超时控制：</p>
<ul>
<li><p>OpenFeign调用微服务时，微服务提供者会立刻给予响应，但如果由于其他原因，提供者无法立马响应，慢个两三秒，那么OpenFeign就会报错，即没有读取响应超时，因为OpenFeign中默认等待的响应时间是<code>1秒</code>，所以我们会根据需要，将OpenFeign的等待时间延长；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8102</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka,</span> <span class="hljs-string">http://eureka7002.com:7002/eureka</span>
      
<span class="hljs-attr">ribbon:</span>
  <span class="hljs-comment">#建立连接后，读取响应最大等待的时间，超过5秒没响应，则报异常	</span>
  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">5000</span>
  <span class="hljs-comment">#建立连接的最大等待时间，超过则报异常</span>
  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">5000</span>
  
<span class="hljs-string">注意：上面的ribbon的属性中，IDEA或Eclipse中没有自动提示上面的ReadTimeout和ConnectTimeout属性，因为不是所有的属性IDEA都会提示，但是没关系，你只要设置了都是生效的</span></code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>OpenFeign的日志打印：</p>
<ul>
<li><p>OpenFeign也有对接口的调用情况进行监控的日志输出功能，主要的日志级别包括：</p>
<ul>
<li><code>NONE</code>：默认的，不显示任何日志；</li>
<li><code>BASIC</code>：仅记录请求方法、URL、响应状态码及执行时间；</li>
<li><code>HEADERS</code>：处理BASIC中定义的信息外，还有请求和响应的头信息；</li>
<li><code>FULL</code>：除了HEADERS中定义的信息之外，还有请求和响应的正文及源数据。</li>
</ul>
</li>
<li><p>基本步骤：</p>
<ul>
<li><p>首先，需要在项目中创建一个日志配置类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignConfig</span> </span>&#123;

    <span class="hljs-meta">@Bean</span>
    Logger.<span class="hljs-function">Level <span class="hljs-title">feignLoggerLevel</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> Logger.Level.FULL;
    &#125;
&#125;</code></pre>
</li>
<li><p>然后，在yml文件中配置要对哪些接口进行监控日志输出；</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">logging</span>:
  <span class="hljs-selector-tag">level</span>:
    #表示以某个日志级别监控某个接口
    <span class="hljs-selector-tag">cn</span><span class="hljs-selector-class">.dyf</span><span class="hljs-selector-class">.springcloud</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.FeignService</span>: <span class="hljs-selector-tag">debug</span></code></pre>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-7-Hystrix–服务降级、熔断、限流"><a href="#NO2-7-Hystrix–服务降级、熔断、限流" class="headerlink" title="NO2.7 Hystrix–服务降级、熔断、限流"></a>NO2.7 Hystrix–服务降级、熔断、限流</h3><ul>
<li>Hystrix：<ul>
<li>介绍：Hystrix是Netflix框架中开源的服务故障隔离、恢复、监控和报警的组件模块。Hystrix通过添加对被依赖服务延迟和故障处理逻辑控制服务间的交互，进而提高整个系统的稳定性；Hystrix可以用在微服务提供端，也可以用在微服务消费端，但一般都用在消费端；</li>
<li>解决的问题：在复杂的分布式系统中往往有大量的服务依赖，在这众多的服务中不可避免得会发生部分服务出现故障的问题。这时候如果主服务没有对被依赖的服务故障进行隔离，那么可能会因为被依赖服务出现的故障拖垮主服务自身；</li>
<li>功能：<ul>
<li>隔离(线程池隔离和信号量隔离)：限制调用分布式服务的资源使用，某一个调用的服务出现问题不会影响其他服务调用；</li>
<li>优雅的降级机制：超时降级、资源不足时(线程或信号量)降级，降级后可以配合降级接口返回托底数据；</li>
<li>熔断：当失败率达到阀值自动触发降级(如因网络故障/超时造成的失败率高)，熔断器触发的快速失败会进行快速恢复；</li>
<li>缓存：提供了请求缓存、请求合并实现；</li>
<li>支持实时监控、报警、控制。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Hystrix概念：<ul>
<li><code>服务降级(fallback)</code>：简单讲，就是当请求没有得到预期的响应的时候，需要返回一个能接受的结果，即达不到最好的，那么你拿一个次一点的响应给我，我也能接受；出现服务降级的常见原因：<ul>
<li>程序运行异常；</li>
<li>响应超时；</li>
<li>由服务熔断触发的服务降级；</li>
<li>线程池/信号量打满也会导致服务降级。</li>
</ul>
</li>
<li><code>服务熔断(break)</code>：通俗的理解，就是类似于保险丝的自我保护，也就是说在达到最大的服务访问后，就不允许用户再访问，直接就给你关闭访问服务，但会调用服务降级的友好提示告诉你访问不了了，因为一旦超出了最大访问，那么有可能导致别的异常，甚至是系统崩溃等等；</li>
<li><code>服务限流(flowlimit)</code>：就是限制访问量，也就是说，不允许过高的访问量(高并发)出现，控制访问量在一定的范围内，就是服务限流的意思。</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Hystrix使用的基本步骤：</p>
<ul>
<li><p>创建cloud-provider-eureka-hystrix-payment8004子项目(以下简称8004子项目)，导入的依赖和其他payment子项目差不多，只是主要需要导入Hystrix依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8004</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-provider-hystrix-payment</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span></code></pre>
</li>
<li><p>配置8004子项目启动类、controller类、service类，原本还有Mapper的，但是这里为了测试方便就直接在service返回“成功返回”的字符串了；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaPayment8004</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaPayment8004<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;

<span class="hljs-comment">//------------------------------</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayService</span> </span>&#123;

	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;server.port&#125;"</span>)
	<span class="hljs-keyword">private</span> String port;

	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;
        
        <span class="hljs-keyword">try</span> &#123;
			<span class="hljs-comment">//睡5秒钟，那么就超出上方的自身的访问响应等待峰值</span>
			Thread.sleep(<span class="hljs-number">5000</span>);
		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
			e.printStackTrace();
		&#125;

		<span class="hljs-comment">//输出</span>
		System.out.println(<span class="hljs-string">"这里运行的是带hystrix的微服务，端口号为："</span>+port);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>创建cloud-consumer-eureka-hystrix-order8103子项目(以下简称8103子项目)，这个子项目是消费端，导入的依赖和8004子项目相同，别忘记导入OpenFeign和Hystrix依赖；</p>
</li>
<li><p>然后配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-string">server</span>
<span class="hljs-attr">port:</span> <span class="hljs-number">8103</span>


<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span></code></pre>
</li>
<li><p>启动类配置；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableFeignClients</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaOrder8103</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaOrder8103<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>OpenFeign接口和controller配置；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"cloud-provider-hystrix-payment"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>;
&#125;

<span class="hljs-comment">//--------------------------------------------</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> feignService.getMessage();
	&#125;
&#125;</code></pre>
</li>
<li><p>那么此时一个微服务和一个消费端都创建完成，当调用方出现大量请求访问(高并发)的情况时，那么相应的被调用的微服务的响应速度就会慢下来，就极大可能导致用户的访问体验变差(如，访问速度变慢，请求资源错误等等)，因此，为了解决这些问题，就出现了Hystrix的服务降级、熔断、限流；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>服务降级配置；</p>
<ul>
<li><p>首先，检查微服务提供方，在service中响应出问题的方法上添加@HystrixCommand注解，该注解作用是预防微服务提供方本身出现问题，从而自身使用hystrix，然后进行服务降级的处理；也就是说访问我这个微服务的时候，出了一些问题，但是我不能让调用方白白等着，要尽快的返回响应，无论是访问能用还是不能用，都要快速的给予调用方一个友好的提示响应；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayService</span> </span>&#123;

	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;server.port&#125;"</span>)
	<span class="hljs-keyword">private</span> String port;

	<span class="hljs-meta">@HystrixCommand</span>(fallbackMethod = <span class="hljs-string">"badMessage"</span>,
			commandProperties = &#123;<span class="hljs-meta">@HystrixProperty</span>(name =<span class="hljs-string">"execution.isolation.thread.timeoutInMilliseconds"</span>,value=<span class="hljs-string">"3000"</span>)&#125;
	)  <span class="hljs-comment">//该注解就是使用Hystrix</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;

        <span class="hljs-comment">//异常</span>
        <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;
        
        
        <span class="hljs-comment">//响应超时</span>
		<span class="hljs-keyword">try</span> &#123;
			<span class="hljs-comment">//睡5秒钟，那么就超出上方的自身的访问响应等待峰值</span>
			Thread.sleep(<span class="hljs-number">5000</span>);
		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
			e.printStackTrace();
		&#125;

		<span class="hljs-comment">//输出</span>
		System.out.println(<span class="hljs-string">"这里运行的是带hystrix的微服务，端口号为："</span>+port);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
	&#125;

	<span class="hljs-comment">//Hystrix服务降级后调用的方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">badMessage</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"出现问题了，这里进行服务降级！"</span>;
	&#125;
&#125;

说明：上面进行了两个test，一个是抛异常，一个是响应超时，测试显示这两个都会触发服务降级。</code></pre>
</li>
<li><p>然后在微服务提供方的启动类上添加@EnableCircuitBreaker注解，该注解就是启用Hystrix服务；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@EnableCircuitBreaker</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaPayment8004</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaPayment8004<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>最后，启动微服务进行测试Hystrix，检查是否会运行服务降级服务，不过要注意的是，因为调用方子项目中使用了OpenFeign进行接口调用，而OpenFeign默认响应等待时间是1秒，所以需要把这个响应等待稍微延长一点就行；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8103</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span>
<span class="hljs-attr">ribbon:</span>
  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">10000</span>
  
<span class="hljs-string">说明：上面是在调用方的yml文件中添加了OpenFeign的响应等待时间为10秒</span></code></pre>

<p><img src="./Image-spc22.png" srcset="/img/loading.gif" alt="image-20200719150734997"></p>
</li>
<li><p>同样，Hystrix也可以用在调用方。首先，配置yml</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8103</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span>
<span class="hljs-attr">ribbon:</span>
  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">10000</span>
  
<span class="hljs-comment">#这里就是支持hystix的使用  </span>
<span class="hljs-attr">feign:</span>
  <span class="hljs-attr">hystrix:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span></code></pre>
</li>
<li><p>其次，在调用方的启动类上添加@EnableHystrix注解，表示启用Hystrix；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableFeignClients</span>
<span class="hljs-meta">@EnableHystrix</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaOrder8103</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(EurekaOrder8103<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>同样的，调用方中，也要配置服务降级调用的方法；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment"</span>)
	<span class="hljs-meta">@HystrixCommand</span>(fallbackMethod = <span class="hljs-string">"badMessage"</span>,
			commandProperties = &#123;<span class="hljs-meta">@HystrixProperty</span>(name =<span class="hljs-string">"execution.isolation.thread.timeoutInMilliseconds"</span>,value=<span class="hljs-string">"1500"</span>)&#125;
	)  <span class="hljs-comment">//该注解就是使用Hystrix</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;
        
        <span class="hljs-comment">//异常</span>
        <span class="hljs-comment">//int a = 1/0;</span>
        
        <span class="hljs-comment">//超时</span>
		<span class="hljs-keyword">return</span> feignService.getMessage();

	&#125;


	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">badMessage</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"1.5秒过去了~~，还是我自己来进行服务降级吧"</span>;
	&#125;
&#125;

说明：同样的，上面也进行了两次test，即抛出异常和响应超时，都成功在调用方中进行了服务降级。</code></pre>
</li>
<li><p>运行微服务，进行微服务调用方的Hystrix服务降级测试即可；</p>
<p><img src="./Image-spc23.png" srcset="/img/loading.gif" alt="image-20200719161342381"></p>
</li>
<li><p>但是，我们发现，如果每个业务方法都需要一个服务降级的响应提示方法的话，那么代码会显得特别的膨胀，所以需要进行配置统一的全局服务降级的响应提示方法，也就是说，除开特别需要标明的一些方法进行一对一的配置之外，其他的方法都可以返回一个普通的、统一的服务降级方法的意思；<code>这里就需要用到@DefaultProperties注解和@HystrixCommand注解进行搭配使用，前者是设置默认的服务降级时调用的方法，后者是标明哪些方法需要服务降级的服务，也就是说如果不标注@HystrixCommand注解的话，那么出现异常或超时响应的话，就该抛异常抛异常，该超时超时。但是该方式代码耦合性会比较强</code>；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@DefaultProperties</span>(defaultFallback = <span class="hljs-string">"globalFallbackMethod"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;


<span class="hljs-comment">//	@HystrixCommand(fallbackMethod = "badMessage",</span>
<span class="hljs-comment">//			commandProperties = &#123;@HystrixProperty(name ="execution.isolation.thread.timeoutInMilliseconds",value="1500")&#125;</span>
<span class="hljs-comment">//	)  //该注解就是使用Hystrix</span>
	
	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment"</span>)
	<span class="hljs-meta">@HystrixCommand</span>  <span class="hljs-comment">//表示该方法有降级方法可调用</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;


		<span class="hljs-keyword">return</span> feignService.getMessage();

	&#125;

	<span class="hljs-comment">//设置服务降级调用的全局方法，也就是标注了@HystrixCommand注解的方法默认都会走这个服务降级方法，除开一些指定要调用某个服务降级方法的那些方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">globalFallbackMethod</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"全局服务降级方法，ZzangZzang~~"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>再次test，检查是否会调用全局服务降级方法即可；</p>
</li>
<li><p>另外，上面的操作是在调用方中解决服务降级方法代码的过于膨胀的问题，但是会让代码的耦合度变强，所以，这里推荐使用另外一种方法：</p>
<ul>
<li><p>首先，为调用方的Feign接口编写一个实现类，对的，你没看错，就是Feign的接口的实现类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignServiceFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"这里是FeignService实现类的Fallback方法"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>然后，需要在yml文件中配置一下：</p>
<pre><code class="hljs java">server:
  port: <span class="hljs-number">8103</span>

eureka:
  client:
    register-with-eureka: <span class="hljs-keyword">false</span>
    service-url:
      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/</span>

#主要就是配置这个，就是开启对Hystrix的支持使用
feign:
  hystrix:
    enabled: <span class="hljs-keyword">true</span></code></pre>
</li>
<li><p>最后，要在OpenFeign的接口中，配置使用HyStrix的服务降级要调用的实现类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"cloud-provider-hystrix-payment"</span>,
fallback = FeignServiceFallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)  </span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">interface</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>;
&#125;

说明：主要就是配置<span class="hljs-meta">@FeignClient</span>注解中的fallback属性，也就是将OpenFeign调用的接口方法和实现类的对应方法进行绑定，然后当调用的接口方法需要调用服务降级的方法时，就会去调用实现类里的对应方法。
    
    
<span class="hljs-comment">//----------------------------------------    </span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;


<span class="hljs-comment">//	@HystrixCommand(fallbackMethod = "badMessage",</span>
<span class="hljs-comment">//			commandProperties = &#123;@HystrixProperty(name ="execution.isolation.thread.timeoutInMilliseconds",value="1500")&#125;</span>
<span class="hljs-comment">//	)  //该注解就是使用Hystrix</span>

	<span class="hljs-comment">//@HystrixCommand  //表示该方法有降级方法可调用</span>
	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> feignService.getMessage();

	&#125;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage2</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> feignService.getMessage2();

	&#125;


	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">globalFallbackMethod</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"全局服务降级方法，ZzangZzang~~"</span>;
	&#125;
&#125; 

说明：controller仍然什么都不需要配置，只要调用OpenFeign的接口即可。</code></pre>
</li>
<li><p>开启微服务，进行test，只要微服务端出现响应超时、服务宕机、出现异常等情况，调用方这边都会进行服务降级处理。</p>
<p><img src="./Image-spc24.png" srcset="/img/loading.gif" alt="image-20200719180146600"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>服务熔断配置：</p>
<ul>
<li><p>为了应对雪崩效应的一种微服务链路保护机制。当链路的某个微服务出现不可以或响应时间太长，会进行服务的降级，进而熔断该节点微服务的调用(即暂时你访问不了这个微服务，可能需要等一会儿才能访问)；当检测到该节点微服务调用响应正常后，恢复调用链路。在Spring Cloud架构中，Hystrix模块就是用来进行服务熔断的实现。即监控微服务调用状况，当失败的调用达到一定阈值，默认是5秒内20次调用失败，就会启动熔断机制，该机制的仍然在@HystrixCommand注解中进行配置；</p>
</li>
<li><p>服务熔断配置：</p>
<ul>
<li><p>服务熔断一般用在微服务提供方，所以需要在8004子项目中进行配置。首先，在业务层中进行配置；</p>
<pre><code class="hljs kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayService</span> </span>&#123;

	<span class="hljs-meta">@Value(<span class="hljs-meta-string">"<span class="hljs-subst">$&#123;server.port&#125;</span>"</span>)</span>
	<span class="hljs-keyword">private</span> String port;

	<span class="hljs-meta">@HystrixCommand(fallbackMethod = <span class="hljs-meta-string">"badMessage"</span>,</span>
<span class="hljs-meta">			commandProperties = &#123;@HystrixProperty(name =<span class="hljs-meta-string">"execution.isolation.thread.timeoutInMilliseconds"</span>,value=<span class="hljs-meta-string">"5000"</span>)</span>&#125;
	)  <span class="hljs-comment">//该注解就是使用Hystrix</span>
	<span class="hljs-keyword">public</span> String getMessage()&#123;

<span class="hljs-comment">//		try &#123;</span>
<span class="hljs-comment">//			//睡5秒钟，那么就超出上方的自身的访问响应等待峰值</span>
<span class="hljs-comment">//			Thread.sleep(3000);</span>
<span class="hljs-comment">//		&#125; catch (InterruptedException e) &#123;</span>
<span class="hljs-comment">//			e.printStackTrace();</span>
<span class="hljs-comment">//		&#125;</span>

		<span class="hljs-comment">//输出</span>
		System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"这里运行的是带hystrix的微服务，端口号为："</span>+port);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
	&#125;

	<span class="hljs-keyword">public</span> String badMessage()&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"出现问题了，这里进行服务降级！"</span>;
	&#125;

<span class="hljs-comment">//---------------------------以下是服务熔断配置</span>

	<span class="hljs-meta">@HystrixCommand(fallbackMethod = <span class="hljs-meta-string">"badMessage2"</span>, commandProperties = &#123;</span>
<span class="hljs-meta">			@HystrixProperty(name = <span class="hljs-meta-string">"circuitBreaker.enabled"</span>,value = <span class="hljs-meta-string">"true"</span>)</span>,  <span class="hljs-comment">//是否开启断路器</span>
			<span class="hljs-meta">@HystrixProperty(name = <span class="hljs-meta-string">"circuitBreaker.requestVolumeThreshold"</span>,value = <span class="hljs-meta-string">"10"</span>)</span>,   <span class="hljs-comment">//请求次数，默认是20</span>
			<span class="hljs-meta">@HystrixProperty(name = <span class="hljs-meta-string">"circuitBreaker.errorThresholdPercentage"</span>,value = <span class="hljs-meta-string">"60"</span>)</span>, <span class="hljs-comment">//请求次数失败率达到多少后跳闸，即开启断路器，默认是50</span>
			<span class="hljs-meta">@HystrixProperty(name = <span class="hljs-meta-string">"circuitBreaker.sleepWindowInMilliseconds"</span>,value = <span class="hljs-meta-string">"10000"</span>)</span>,  <span class="hljs-comment">//经过一定时间进行尝试半开接收请求，没问题则恢复，否则还会继续熔断，默认5秒</span>

	&#125;)
	<span class="hljs-keyword">public</span> String getMessage2()&#123;

		<span class="hljs-comment">//输出</span>
		System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"正在测试熔断服务，端口号为："</span>+port);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
	&#125;

	<span class="hljs-keyword">public</span> String badMessage2()&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"又出现问题了，这里进行服务熔断！"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>其实，在上面的代码中，就已经配置完成了服务熔断，下面的代码只是为了更好地测试而添加的代码；往微服务提供方的controller中添加一个方法，来调用配置了服务熔断的方法；</p>
<pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> PayService payService;

	<span class="hljs-meta">@GetMapping(<span class="hljs-meta-string">"/hystrix/payment"</span>)</span>
	<span class="hljs-keyword">public</span> String getMessage()&#123;

		<span class="hljs-keyword">return</span> payService.getMessage();
	&#125;

	<span class="hljs-comment">//调用熔断配置的方法</span>
	<span class="hljs-meta">@GetMapping(<span class="hljs-meta-string">"/hystrix/payment2"</span>)</span>
	<span class="hljs-keyword">public</span> String getMessage2()&#123;

		<span class="hljs-keyword">return</span> payService.getMessage2();
	&#125;
&#125;</code></pre>
</li>
<li><p>最后是调用方，需要添加一个方法去调用熔断配置的方法；</p>
<pre><code class="hljs java"><span class="hljs-comment">//controller层</span>

<span class="hljs-comment">//@DefaultProperties(defaultFallback = "globalFallbackMethod")</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;


<span class="hljs-comment">//	@HystrixCommand(fallbackMethod = "badMessage",</span>
<span class="hljs-comment">//			commandProperties = &#123;@HystrixProperty(name ="execution.isolation.thread.timeoutInMilliseconds",value="1500")&#125;</span>
<span class="hljs-comment">//	)  //该注解就是使用Hystrix</span>

	<span class="hljs-comment">//@HystrixCommand  //表示该方法有降级方法可调用</span>
	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;


		<span class="hljs-keyword">return</span> feignService.getMessage();

	&#125;

	<span class="hljs-comment">//调用熔断配置的方法</span>
	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/hystrix/payment2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage2</span><span class="hljs-params">()</span></span>&#123;


		<span class="hljs-keyword">return</span> feignService.getMessage2();

	&#125;


	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">globalFallbackMethod</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"全局服务降级方法，ZzangZzang~~"</span>;
	&#125;
&#125;

<span class="hljs-comment">//------------------------</span>

<span class="hljs-comment">//Feign接口层</span>

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"cloud-provider-hystrix-payment"</span>,fallback = FeignServiceFallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">interface</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix/payment"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>;

	<span class="hljs-comment">//调用熔断配置的方法</span>
	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix/payment2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage2</span><span class="hljs-params">()</span></span>;
&#125;

<span class="hljs-comment">//------------------------</span>

<span class="hljs-comment">//Feign接口实现层(即Feign接口层fallback方法调用层)</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignServiceFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeignService</span> </span>&#123;


	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"这里是FeignService实现类的Fallback方法"</span>;
	&#125;

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage2</span><span class="hljs-params">()</span>  </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"这里是payment2方法的fallback方法"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>最后进行服务熔断测试；</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>服务限流：学到Spring Cloud sentinel时再讲；</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Hystrix的图形化显示界面：Hystrix Dashboard配置；</p>
<ul>
<li><p>创建子项目，并导入依赖：</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--eureka client--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableHystrixDashboard</span>  <span class="hljs-comment">//启用HystrixDashboard</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HystrixDashboard9001</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(HystrixDashboard9001<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>在微服务提供方中，添加依赖；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--监控--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

说明：现在目标该依赖主要是干什么了的吧，就是用于监控微服务提供者的状态。</code></pre>
</li>
<li><p>最后，打开<code>localhost:9001/hystrix</code>地址，如果出现如下图所示，表示HystrixDashboard监控网站搭建成功；</p>
<p><img src="./Image-spc25.png" srcset="/img/loading.gif" alt="image-20200720135701390"></p>
</li>
<li><p>如果想要查看监控的微服务，首先要在指定监控的微服务的启动类中，添加一个方法，且启动类上要有@EnableCircuitBreaker注解(作用是启用Hystrix)；这里以8004子项目为例；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@EnableCircuitBreaker</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaPayment8004</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaPayment8004<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;


    <span class="hljs-comment">//要添加的方法</span>
	<span class="hljs-meta">@Bean</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> ServletRegistrationBean <span class="hljs-title">getServlet</span><span class="hljs-params">()</span></span>&#123;
		HystrixMetricsStreamServlet streamServlet = <span class="hljs-keyword">new</span> HystrixMetricsStreamServlet();
		ServletRegistrationBean registrationBean = <span class="hljs-keyword">new</span> ServletRegistrationBean(streamServlet);
		registrationBean.setLoadOnStartup(<span class="hljs-number">1</span>);
		registrationBean.addUrlMappings(<span class="hljs-string">"/hystrix.stream"</span>);
		registrationBean.setName(<span class="hljs-string">"HystrixMetricsStreamServlet"</span>);
		<span class="hljs-keyword">return</span> registrationBean;
	&#125;
&#125;

说明：
一、监控微服务步骤：
	<span class="hljs-number">1</span>.需要监控的微服务项目中，导入actuator监控依赖；
    <span class="hljs-number">2</span>.需要监控的微服务项目中，其启动类里添加上述的方法；
    <span class="hljs-number">3</span>.<span class="hljs-meta">@EnableCircuitBreaker</span>注解必须</code></pre>
</li>
<li><p>然后在Hystrix Dashboard页面的如下位置中，添加要监控的微服务url即可；如，我监控的是8004子项目，那么url为：<code>http://localhost:8004/hystrix.stream</code>；另外监控示意图解析在最下面。</p>
<p><img src="./Image-spc26.png" srcset="/img/loading.gif" alt="image-20200720142315269"></p>
<p><img src="./Image-spc27.png" srcset="/img/loading.gif" alt="image-20200720142431030"></p>
<p><img src="./Image-spc28.png" srcset="/img/loading.gif" alt="image-20200720142556465"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-8-Gateway–路由网关"><a href="#NO2-8-Gateway–路由网关" class="headerlink" title="NO2.8 Gateway–路由网关"></a>NO2.8 Gateway–路由网关</h3><ul>
<li>Gateway：<ul>
<li>介绍：SpringCloud Gateway是SpringCloud的一个权限项目，基于Spring5.0、SpringBoot2.0、Project Reactor等技术开发的网关，它旨在为微服务架构提供一种简单有效、统一的API路由管理方式；Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty；而网关的角色是作为一个API架构，用来保护、增强和控制对于API服务的访问。</li>
<li>功能：<ul>
<li>反向代理；</li>
<li>鉴权；</li>
<li>流量控制；</li>
<li>熔断；</li>
<li>日志监控等等；</li>
</ul>
</li>
<li>核心概念：<ul>
<li>Route(路由)：路由是构建网关的基本模块，它由ID、目标URI、一系列的断言和过滤器组成，如果断言为true则匹配该路由；</li>
<li>Predicate(断言)：开发人员可以匹配HTTP请求中的所有内容(如，请求头或请求参数)，如果请求与断言相匹配则进行路由；</li>
<li>Filter(过滤)：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Gateway配置：</p>
<ul>
<li><p>首先，创建cloud-gateway-gateway9527子项目(以下简称9527子项目)，并导入依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--gateway--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--eureka client--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

注意：引入gatewall网关依赖，就不需要引入web和actuator的依赖，否则的话，启动网关微服务就会报错。</code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9527</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-gateway</span>

  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      	<span class="hljs-comment">#这是路由的id，没有固定规则但要求唯一，建议配合服务名</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh</span>  
      
        <span class="hljs-comment">#2.首先经过断言的判断为true后，才会走这里，即具体去访问哪个ip和端口下的微服务，</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8001</span>   
        
        <span class="hljs-comment">#1.这是断言，客户端输入的访问url，会先跟这里进行匹配判断，路径相匹配的进行路由</span>
        <span class="hljs-attr">predicates:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/get/**</span>   

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh2</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8001</span>
        <span class="hljs-attr">predicates:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/create/**</span>   


<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">cloud-gateway-service</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span></code></pre>
</li>
<li><p>配置启动类；因为网关只做分发请求，所以不需要业务类；</p>
<pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableEurekaClient</span>
public class EurekaGateway9527 &#123;
    <span class="hljs-comment">//main方法</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args)&#123;

        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(EurekaGateway9527.class,args);
    &#125;
&#125;</code></pre>
</li>
<li><p>最后，进行测试网关的访问；</p>
</li>
</ul>
<p><img src="./Image-spc29.png" srcset="/img/loading.gif" alt="image-20200720160744482"></p>
</li>
<li><p>另外，除了使用yml配置网关，还可以使用基于Java的配置方式；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GatewayConfig</span> </span>&#123;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder routeLocatorBuilder)</span> </span>&#123;
        RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes();
        routes.route(<span class="hljs-string">"xxx_routh"</span>,
                     r -&gt;r.path(<span class="hljs-string">"/guonei"</span>)
                     .uri(<span class="hljs-string">"http://news.baidu.com/guonei"</span>)).build();
        <span class="hljs-keyword">return</span> routes.build();
    &#125;
&#125;</code></pre>

</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>动态路由配置；</p>
<ul>
<li><p>默认情况下Gateway会根据注册中心注册的服务列表，以注册中心上微服务名为路径，创建动态路由进行转发，从而实现动态路由的功能；所以这里只需要配置yml文件即可；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9527</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-gateway</span>

  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">locator:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span>

      <span class="hljs-attr">routes:</span>  <span class="hljs-comment">#配置多个路由网关</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh</span>  <span class="hljs-comment">#这是路由的id，没有固定规则但要求唯一，建议配合服务名</span>
        
        <span class="hljs-comment">#2.首先经过断言的判断为true后，才会走这里，即具体去访问哪个微服务</span>
        <span class="hljs-comment">#uri: http://localhost:8001</span>
        <span class="hljs-comment">#这里的lb表示以LoadBalanceClient方式请求后面的微服务，其实就是负载均衡</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://cloud-payment-service</span>
          

        <span class="hljs-comment">#1.这是断言，客户端输入的访问url，会先跟这里进行匹配判断，路径相匹配的进行路由</span>
        <span class="hljs-attr">predicates:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/get/**</span>  

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh2</span>
        <span class="hljs-comment">#uri: http://192.168.1.59:8001</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://cloud-payment-service</span>
        
        <span class="hljs-attr">predicates:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/get/**</span> 


<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">cloud-gateway-service</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span></code></pre>
</li>
<li><p>然后再次测试后，就可以发现，访问的微服务出现了负载均衡的调用机制；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Predicate断言的配置：</p>
<ul>
<li><p>After：在指定时间之后进行路由；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">after_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">After=2019-01-20T17:42:47.789-07:00[America/Denver]</span>
          
            
<span class="hljs-string">说明：该路由匹配所有UTC时间Jan</span> <span class="hljs-number">20</span><span class="hljs-string">,</span> <span class="hljs-number">2019</span> <span class="hljs-number">17</span><span class="hljs-string">:42后的请求，并且路由到uri:https://example.org</span>        
    
<span class="hljs-string">注意：可以使用ZoneDateTime.now()方法获得上面的那个形式的时间格式</span></code></pre>
</li>
<li><p>Before：在指定时间之前进行路由；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">before_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Before=2019-01-20T17:42:47.789-07:00[America/Denver]</span>   
        
<span class="hljs-string">说明：该路由匹配所有UTC时间Jan</span> <span class="hljs-number">20</span><span class="hljs-string">,</span> <span class="hljs-number">2019</span> <span class="hljs-number">17</span><span class="hljs-string">:42之前的请求，并且路由到uri:https://example.org</span></code></pre>
</li>
<li><p>Between：在指定时间之间进行路由；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">between_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Between=2019-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="hljs-number">2019</span><span class="hljs-number">-01</span><span class="hljs-string">-21T17:42:47.789-07:00[America/Denver]</span>

<span class="hljs-string">说明：如果在这个时间区间，就可以正常匹配路由并访问。</span></code></pre>
</li>
<li><p>Cookie：携带指定的cookie信息完全匹配后，才进行路由；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">cookie_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Cookie=chocolate,</span> <span class="hljs-string">ch.p</span>

<span class="hljs-string">说明：这个路由将匹配cookie中存在chocolate=ch.p的请求。</span></code></pre>

<p><img src="./Image-spc47.png" srcset="/img/loading.gif" alt="image-20200725144651715"></p>
<p><code>说明：使用curl进行携带指定cookie信息进行访问网关，默认是get请求，这就是curl测试访问，和postman差不多，只不过是命令行形式的。</code></p>
</li>
<li><p>Header：携带指定的Header信息完全匹配后，才进行路由；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">header_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Header=X-Request-Id,</span> <span class="hljs-string">\d+</span>

<span class="hljs-string">说明：这个路由将匹配请求头中包含X-Request-Id且值为一个或者多个数字的请求</span></code></pre>
</li>
<li><p>Host ：</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">host_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Host=**.somehost.org,**.anotherhost.org</span>
        
<span class="hljs-string">说明：这个路由将匹配请求的Host头为www.somehost.org</span> <span class="hljs-string">或</span> <span class="hljs-string">beta.somehost.org</span> <span class="hljs-string">或</span> <span class="hljs-string">www.anotherhost.org</span></code></pre>
</li>
<li><p>Method：</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">method_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span>

<span class="hljs-string">说明：该路由匹配HttpMethod为Get的请求</span></code></pre>
</li>
<li><p>Path：</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">host_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/foo/&#123;segment&#125;,/bar/&#123;segment&#125;</span>

<span class="hljs-string">说明：如有请求地址如</span> <span class="hljs-string">/foo/1</span> <span class="hljs-string">或</span> <span class="hljs-string">/foo/bar</span> <span class="hljs-string">或</span> <span class="hljs-string">/bar/baz，那么将匹配该路由</span></code></pre>
</li>
<li><p>Query：</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">query_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">Query=foo,baz</span>

<span class="hljs-string">说明：当前路由将匹配路径参数包含foo=baz的请求</span></code></pre>
</li>
<li><p>RemoteAddr：</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">remoteaddr_route</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span>
        <span class="hljs-attr">predicates:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">RemoteAddr=192.168.1.1/24</span>

<span class="hljs-string">说明：请求发起端ip为192.168.1.1~192.168.1.255的请求</span></code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Gateway过滤器；</p>
<ul>
<li><p>生命周期：</p>
<ul>
<li>PRE：这种过滤器会在请求被路由之前调用。</li>
<li>POST：这种过滤器会在路由到微服务以后执行。</li>
</ul>
</li>
<li><p>种类：</p>
<ul>
<li>单一过滤器：即GatewayFilter，一般应用到单个路由或者一个分组的路由上，在配置文件中的写法同predict类似；</li>
<li>全局过滤器：即GlobalFilter，是针对于所有路由的全局过滤器；</li>
</ul>
</li>
<li><p><code>自定义过滤器(推荐)</code>：一般都是自定义过滤器，然后在这个过滤器里面进行权限检查，日志记录等等，配置自己想要的功能；代码如下：</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;
        
        String username = exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">"username"</span>);
        
        <span class="hljs-comment">//用户名为空时，给出错误响应</span>
        <span class="hljs-keyword">if</span> (username == <span class="hljs-keyword">null</span>) &#123;
            log.info(<span class="hljs-string">"用户名为空，非法登录"</span>);
            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);
            <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();
        &#125;
        
        <span class="hljs-comment">//放行方法</span>
        <span class="hljs-keyword">return</span> chain.filter(exchange);
    &#125;

    <span class="hljs-comment">//设置过滤器优先级，0最大，越往后数字越大，优先级越低</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    &#125;
&#125;

说明：自定义过滤器，一般要实现两个接口GlobalFilter和Ordered，前者声明这是个全局过滤器，后者获取过滤器优先级</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-9-Config–分布式配置中心"><a href="#NO2-9-Config–分布式配置中心" class="headerlink" title="NO2.9 Config–分布式配置中心"></a>NO2.9 Config–分布式配置中心</h3><p>每个微服务，几乎都有一个配置文件，那么当我们项目越来越大，相应的微服务也会越来越多，一旦出现什么问题需要修改配置文件时，那么有可能要修改多个，这样就会显得很繁琐和麻烦，而config就算为了解决这个问题，因此而产生的产品。</p>
<ul>
<li>Config：<ul>
<li>介绍：SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置；SpringCloud Config分为服务端和客户端两部分：<ul>
<li>服务端：服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密/解密信息等访问接口；</li>
<li>客户端：客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容。</li>
</ul>
</li>
<li>优点：<ul>
<li>集中管理配置文件；</li>
<li>不同环境不同配置，动态化的配置更新，分环境部署。<code>如，dev/test/prod/beta/release</code>；</li>
<li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心；</li>
<li>统一拉取配置自己的信息；</li>
<li>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置；</li>
<li>将配置信息以REST就接口的形式暴露。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Config服务端和GitHub联动配置：</p>
<ul>
<li><p>由于Config的配置文件一般都会放在GitHub上，然后使用Git对其进行操作。所以，首先需要在GitHub上创建存放配置文件的仓库，然后使用Git测试与GitHub配置文件仓库的连接，成功关联即可；</p>
</li>
<li><p>然后，创建cloud-config-center3344子项目(以下简称3344子项目)，并导入依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!--config server--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--eureka client--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3344</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-config-center</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">server:</span>
        <span class="hljs-attr">git:</span>
          <span class="hljs-attr">uri:</span>  <span class="hljs-comment">#填写你自己的github路径</span>
          <span class="hljs-attr">search-paths:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">springcloud-config</span>  <span class="hljs-comment">#根据上面的uri找到在GitHub中心配置仓库之后，具体找这里的仓库</span>
      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span>  <span class="hljs-string">http://localhost:7001/eureka</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableConfigServer</span>  <span class="hljs-comment">//启用Config服务配置中心</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaConfig3344</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(EurekaConfig3344<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>最后测试访问3344子项目微服务即可：<code>http://微服务ip和端口/分支名/配置文件名.后缀</code>；详细的请求路径如下：</p>
<pre><code class="hljs java"><span class="hljs-comment">//推荐这两种</span>
/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml
/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties    

<span class="hljs-comment">//其他几种方法路径，了解即可</span>
/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]
/&#123;application&#125;-&#123;profile&#125;.yml
/&#123;application&#125;-&#123;profile&#125;.properties</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>客户端和服务端Config的联动配置；</p>
<ul>
<li><p>创建cloud-config-client3355子项目(以下简称3355子项目)，并导入依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--eureka client--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置bootstrap.yml文件，这个是个什么文件呢，简单讲该文件是系统级的配置文件，优先级更高，主要用于从Config配置中心拉取配置信息到该文件中；那么application.yml就不用了吗？不是的，原先的application.yml文件仍然会使用，但是会与bootstrap.yml进行一个整合，这样才是一个完整的配置文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3355</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span>  <span class="hljs-comment">#分支名</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>  <span class="hljs-comment">#要拉取的配置文件名称</span>
      <span class="hljs-attr">profile:</span> <span class="hljs-string">dev</span>  <span class="hljs-comment">#要拉取的配置文件的后缀</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:3344</span>  <span class="hljs-comment">#config配置中心的地址，所以组合起来就是读取http://localhost:3344/master/config-dev.yml文件，注意这里的“-”，它会自己帮你添加上去</span>
<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableEurekaClient</span>
public class EurekaConfigClient3355 &#123;
	
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args)&#123;

		<span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(EurekaConfigClient3355.class,args);
	&#125;
&#125;</code></pre>
</li>
<li><p>这里创建一个controller地址测试；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;
	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;config.info&#125;"</span>)
	<span class="hljs-keyword">private</span> String configInfo;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/configInfo"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getConfigInfo</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> configInfo;
	&#125;
&#125;

说明：即从Config配置中心拉取到配置信息后，这里就会输出响应的信息，就相当于测试了</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>客户端手动动态刷新从Config配置中心拉取的信息；</p>
<ul>
<li><p>需求：因为GitHub上的是公共配置，所以，当公共配置修改后，Config配置中心会自动拉取到最新的配置信息，但是客户端却只能重新启动微服务，然后再获取最新的配置信息，这样就比较耗费资源了，所以我们需要配置动态刷新客户端中的信息；</p>
</li>
<li><p>首先，添加监控依赖；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--监控--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>然后配置bootstrap.xml文件，目的为了暴露监控端口；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3355</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span>  <span class="hljs-comment">#分支名</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>  <span class="hljs-comment">#要拉取的配置文件名称</span>
      <span class="hljs-attr">profile:</span> <span class="hljs-string">dev</span>  <span class="hljs-comment">#要拉取的配置文件的后缀</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:3344</span>  <span class="hljs-comment">#config配置中心的地址，所以组合起来就是读取http://localhost:3344/master/config-dev.yml文件，注意这里的“-”，它会自己帮你添加上去</span>
<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span>

<span class="hljs-comment">#暴露监控端口</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">"*"</span></code></pre>
</li>
<li><p>在业务类上添加@RefreshScope注解；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RefreshScope</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;
	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;config.info&#125;"</span>)
	<span class="hljs-keyword">private</span> String configInfo;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/configInfo"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getConfigInfo</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> configInfo;
	&#125;
&#125;
说明：因为这里没有添加业务类，我就加在了controller类上，但该注解一般是用在业务类上的。</code></pre>
</li>
<li><p>此时，进行测试后发现，微服务端还是没有自动刷新配置信息，这是因为需要运维人员发送Post请求去刷新3355子项目；</p>
<p><img src="./Image-spc31.png" srcset="/img/loading.gif" alt="image-20200721161609086"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-10-BUS–消息总线"><a href="#NO2-10-BUS–消息总线" class="headerlink" title="NO2.10 BUS–消息总线"></a>NO2.10 BUS–消息总线</h3><p>为了解决上面Config配置中心的手动刷新配置问题，BUS出现了。</p>
<ul>
<li>BUS：<ul>
<li>介绍：pring Cloud Bus将分布式的节点用轻量的消息代理连接起来。它可以用于广播配置文件的更改或者服务之间的通讯，也可以用于监控；</li>
<li>支持的软件：RibbitMQ、Kafka；</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>使用BUS解决Config客户端手动刷新配置信息的问题；</p>
<ul>
<li><p>原理：Config客户端实例都监听MQ中同一个topic(默认是springcloudbus)。当一个服务刷新数据的时候，MQ会把这个信息放入到Topic中，这样其他监听了这个Topic的服务就能收到通知，然后去更新自身的配置；</p>
</li>
<li><p>首先，安装Erlang和RabbitMQ，这一部分参考RabbitMQ部分的学习笔记即可；</p>
</li>
<li><p>然后，创建cloud-config-client3366子项目(以下简称3366子项目)，创建步骤和3355子项目一致；</p>
</li>
<li><p>我们使用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置；所以，我们需要在Config配置中心进行配置，首先往3344子项目中添加一个AMQP依赖；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>然后再配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3355</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span>  <span class="hljs-comment">#分支名</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>  <span class="hljs-comment">#要拉取的配置文件名称</span>
      <span class="hljs-attr">profile:</span> <span class="hljs-string">dev</span>  <span class="hljs-comment">#要拉取的配置文件的后缀</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:3344</span>  <span class="hljs-comment">#config配置中心的地址，所以组合起来就是读取http://localhost:3344/master/config-dev.yml文件，注意这里的“-”，它会自己帮你添加上去</span>
      
  <span class="hljs-comment">#配置连接到RabbitMQ</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">"*"</span></code></pre>
</li>
<li><p>其次，往3355和3366子项目中分别添加依赖，注意是两个子项目都添加；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>分别配置两个子项目的yml文件，主要就是连接到RabbitMQ；</p>
<pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3355</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span>  <span class="hljs-comment">#分支名</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>  <span class="hljs-comment">#要拉取的配置文件名称</span>
      <span class="hljs-attr">profile:</span> <span class="hljs-string">dev</span>  <span class="hljs-comment">#要拉取的配置文件的后缀</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:3344</span>  <span class="hljs-comment">#config配置中心的地址，所以组合起来就是读取http://localhost:3344/master/config-dev.yml文件，注意这里的“-”，它会自己帮你添加上去</span>
      
  <span class="hljs-comment">#主要是配置这里，即配置连接到RabbitMQ</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">"*"</span></code></pre>
</li>
<li><p>最后，运行微服务进行测试即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>BUS动态刷新定点通知；</p>
<ul>
<li><p>需求：我想只通知某个微服务修改配置，而不是全部都修改，该如何配置？</p>
</li>
<li><p>解决：将配置更新的消息，根据Config配置中心配置的destination参数，会指定去更新需要更新配置的服务或实例；也就是说只要修改配置后，想要定点更新配置的话，此时需要使用curl发送一个请求即可，模板为：<code>http://IP:配置中心端口号/actuator/bus-refresh/{destination}</code>；</p>
<p><img src="./Image-spc32.png" srcset="/img/loading.gif" alt="image-20200721180050652"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-11-Stream–消息驱动"><a href="#NO2-11-Stream–消息驱动" class="headerlink" title="NO2.11 Stream–消息驱动"></a>NO2.11 Stream–消息驱动</h3><ul>
<li><p>Stream：</p>
<ul>
<li><p>介绍：SpringCloud Stream消息驱动可以简化开发人员对消息中间件的使用复杂度，让系统开发人员更多尽力专注于核心业务逻辑的开发。SpringCloud Stream基于SpringBoot实现，自动配置化的功能可以帮助我们快速上手学习，类似于我们之前学习的hibernate框架一样，可以不用改sql语句，也可以切换不同的数据库，SpringCloud Stream 目前只支持RabbitMQ和Kafka；</p>
</li>
<li><p>原理：Stream组件底层对RabbitMQ和Kafka，进行封装成同一个API，Stream使用Binder与底层不同的MQ进行交互，而开发人员只需要对接Stream即可，也就是我们与Binder进行交互就行； </p>
<p><img src="./Image-spc33.png" srcset="/img/loading.gif" alt="image-20200722112225771"></p>
</li>
<li><p>设计思想：Stream中的消息通信发送遵循了发布-订阅模式；</p>
</li>
<li><p>常用注解和API：</p>
<table>
<thead>
<tr>
<th>组成</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Middleware</td>
<td>中间件，目前只支持RabbitMQ和Kafka</td>
</tr>
<tr>
<td>Binder</td>
<td>Binder是应用于消息中间件之间的封装，目前实行了Kafka和RabbitMQ的Binder，通过Binder可以很方便的连接中间件，可以动态的改变消息类型（对应于Kafka的topic，RabbitMQ的exchange），这些都可以通过配置文件来实现</td>
</tr>
<tr>
<td><code>@Input</code></td>
<td>注解标识输入通道，通过该输入通道接收到的消息进入应用程序</td>
</tr>
<tr>
<td><code>@Output</code></td>
<td>注解标识输出通道，发布的消息将通过该通道离开应用程序</td>
</tr>
<tr>
<td><code>@StreamListener</code></td>
<td>监听队列，用于消费者的队列的消息接收</td>
</tr>
<tr>
<td><code>@EnableBinding</code></td>
<td>指信道channel和exchange绑定在一起</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Stream消息驱动–生产者；</p>
<ul>
<li><p>创建cloud-provider-stream-rabbitmq8801子项目(以下简称8801子项目)，并导入依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--eureka client--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--stream rabbit --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8801</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-stream-provider</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">binders:</span> <span class="hljs-comment"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span class="hljs-attr">defaultRabbit:</span> <span class="hljs-comment"># 表示定义的名称，用于与binding整合</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">rabbit</span> <span class="hljs-comment"># 消息组件类型</span>
          <span class="hljs-attr">environment:</span> <span class="hljs-comment"># 设置rabbitmq的相关的环境配置</span>
            <span class="hljs-attr">spring:</span>
              <span class="hljs-attr">rabbitmq:</span>
                <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
                <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
                <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
                <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
      <span class="hljs-attr">bindings:</span> <span class="hljs-comment"># 服务的整合处理</span>
        <span class="hljs-attr">output:</span> <span class="hljs-comment"># 这个名字是一个通道的名称</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">studyExchange</span> <span class="hljs-comment"># 表示要使用的Exchange名称定义</span>
          <span class="hljs-attr">content-type:</span> <span class="hljs-string">application/json</span> <span class="hljs-comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">defaultRabbit</span>  <span class="hljs-comment"># 设置要绑定的消息服务的具体设置</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span> <span class="hljs-comment"># 客户端进行Eureka注册的配置</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:7001/eureka</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 设置心跳的时间间隔(默认是30秒)</span>
    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 如果现在超过了5秒的间隔(默认是90秒)</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">send-8801.com</span>  <span class="hljs-comment"># 在信息列表时显示主机名称</span>
    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment"># 访问的路径变为IP地址</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamProvider8801</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(StreamProvider8801<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置业务类；</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IMessageService</span> </span>&#123;
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">send</span><span class="hljs-params">()</span></span>;
&#125;

<span class="hljs-comment">//--------------------------------</span>

<span class="hljs-keyword">package</span> cn.dyf.springcloud.service.impl;

<span class="hljs-keyword">import</span> cn.dyf.springcloud.service.IMessageService;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.messaging.Source;
<span class="hljs-keyword">import</span> org.springframework.integration.support.MessageBuilder;
<span class="hljs-keyword">import</span> org.springframework.messaging.MessageChannel;

<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@auther</span>: 带头大哥杰尼龟</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2020-07-21 18:59</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@EnableBinding</span>(Source<span class="hljs-class">.<span class="hljs-keyword">class</span>)  //该注解用于将<span class="hljs-title">Channel</span>与<span class="hljs-title">Binder</span>进行一个绑定，因为我们现在只与<span class="hljs-title">Binder</span>进行交互，那么这一步就相当于设计建立一根输出</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">IMessageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IMessageService</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> MessageChannel output;  <span class="hljs-comment">//该对象就是实际的消息输送管道</span>

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;  <span class="hljs-comment">//消息管道已经实际建立了，那么我们就可以发送消息了</span>

		output.send(MessageBuilder.withPayload(<span class="hljs-string">"你好，Stream"</span>).build());  <span class="hljs-comment">//构建一则消息</span>

		<span class="hljs-comment">//输出</span>
		System.out.println(<span class="hljs-string">"消息构建成功"</span>);

		<span class="hljs-keyword">return</span> <span class="hljs-string">"Stream output ok"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> IMessageService im;

	<span class="hljs-meta">@GetMapping</span>(value = <span class="hljs-string">"/sendMessage"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sendMess</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> im.send();
	&#125;
&#125;</code></pre>
</li>
<li><p>开启微服务测试即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Stream消息驱动–消费者；</p>
<ul>
<li><p>创建cloud-consumerr-stream-rabbitmq8802子项目(以下简称8802子项目)，构建的基本步骤和8801子项目差不多；</p>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8802</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-stream-consumer</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">binders:</span> <span class="hljs-comment"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span class="hljs-attr">defaultRabbit:</span> <span class="hljs-comment"># 表示定义的名称，用于于binding整合</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">rabbit</span> <span class="hljs-comment"># 消息组件类型</span>
          <span class="hljs-attr">environment:</span> <span class="hljs-comment"># 设置rabbitmq的相关的环境配置</span>
            <span class="hljs-attr">spring:</span>
              <span class="hljs-attr">rabbitmq:</span>
                <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
                <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
                <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
                <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
      <span class="hljs-attr">bindings:</span> <span class="hljs-comment"># 服务的整合处理</span>
        <span class="hljs-attr">input:</span> <span class="hljs-comment"># 这个名字是一个通道的名称</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">studyExchange</span> <span class="hljs-comment"># 表示要使用的Exchange名称定义</span>
          <span class="hljs-attr">content-type:</span> <span class="hljs-string">application/json</span> <span class="hljs-comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">defaultRabbit</span>  <span class="hljs-comment"># 设置要绑定的消息服务的具体设置</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span> <span class="hljs-comment"># 客户端进行Eureka注册的配置</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:7001/eureka</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 设置心跳的时间间隔(默认是30秒)</span>
    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 如果现在超过了5秒的间隔(默认是90秒)</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">receive-8802.com</span>  <span class="hljs-comment"># 在信息列表时显示主机名称</span>
    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment"># 访问的路径变为IP地址</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamConsumer8802</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(StreamConsumer8802<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;
注意：<span class="hljs-number">8801</span>子项目和<span class="hljs-number">8802</span>子项目都没写<span class="hljs-meta">@EnableEurekaClient</span>注解也可以将本服务注册进Eureka，这是SpringCloud的新特性，因为配置文件中默认配置的是将本服务注册进Eureka</code></pre>
</li>
<li><p>配置获取MQ消息的controller；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> IMessageService im;

	<span class="hljs-meta">@GetMapping</span>(value = <span class="hljs-string">"/sendMessage"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sendMess</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> im.send();
	&#125;
&#125;</code></pre>
</li>
<li><p>开启微服务进行发送和消费消息测试即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Stream中的消费者一般分为两类：<ul>
<li>同一组：和其他组一样，都订阅了某个主题的消息，那么当队列中有消息时，订阅了该主题的所有组都会消费该消息。<code>如，A和B是两个不同的消费者组，C是消息生产者，C生产的消息会发送到消息队列MQ中的d主题，那么只要订阅了d主题的A和B，两个人同时都可以消费到该消息</code>；</li>
<li>非同一组：即，多个消息消费者是同一个消费者组，那么这多个消息消费者互相之间就是竞争关系，简单说，就是只要一个消费者才能消费该消息。<code>如，A和B是同一消费者组的消息消费者，那么当该消费者组收到MQ的消息时，A和B会进行竞争，然后去获取消息，也就是同一个消费者组中只有一个人能获得该消息的消费</code>；</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>在Stream中配置消费者的分组：</p>
<ul>
<li><p>需要在相应消费者微服务中的yml配置文件里配置不同的组名：只要把多个消费者的Spring.cloud.stream.bindings.input.group属性设置为相同组名，那么这多个消费者就都属于同一个消费者。</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8802</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-stream-consumer</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">binders:</span> <span class="hljs-comment"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span class="hljs-attr">defaultRabbit:</span> <span class="hljs-comment"># 表示定义的名称，用于于binding整合</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">rabbit</span> <span class="hljs-comment"># 消息组件类型</span>
          <span class="hljs-attr">environment:</span> <span class="hljs-comment"># 设置rabbitmq的相关的环境配置</span>
            <span class="hljs-attr">spring:</span>
              <span class="hljs-attr">rabbitmq:</span>
                <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
                <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
                <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
                <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
      <span class="hljs-attr">bindings:</span> <span class="hljs-comment"># 服务的整合处理</span>
        <span class="hljs-attr">input:</span> <span class="hljs-comment"># 这个名字是一个通道的名称</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">studyExchange</span> <span class="hljs-comment"># 表示要使用的Exchange名称定义</span>
          <span class="hljs-attr">content-type:</span> <span class="hljs-string">application/json</span> <span class="hljs-comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">defaultRabbit</span>  <span class="hljs-comment"># 设置要绑定的消息服务的具体设置</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">sp1</span>  <span class="hljs-comment">#该消费这处于哪个分组，目前在sp1分组</span>

<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span> <span class="hljs-comment"># 客户端进行Eureka注册的配置</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:7001/eureka</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 设置心跳的时间间隔(默认是30秒)</span>
    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 如果现在超过了5秒的间隔(默认是90秒)</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">receive-8802.com</span>  <span class="hljs-comment"># 在信息列表时显示主机名称</span>
    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment"># 访问的路径变为IP地址</span></code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO2-12-Sleuth–分布式请求链路跟踪"><a href="#NO2-12-Sleuth–分布式请求链路跟踪" class="headerlink" title="NO2.12 Sleuth–分布式请求链路跟踪"></a>NO2.12 Sleuth–分布式请求链路跟踪</h3><ul>
<li>Sleuth：<ul>
<li>介绍：微服务跟踪(Sleuth)其实是一个工具，它在整个分布式系统中能跟踪一个用户请求的过程(包括数据采集、数据传输、数据存储、数据分析、数据可视化)，捕获这些跟踪数据，就能构建微服务的整个调用链的视图，这是调试和监控微服务的关键工具；</li>
<li>功能：<ul>
<li>提供链路追踪：通过Sleuth可以很清楚的看出一个请求经过了哪些服务，可以方便的理清服务局的调用关系；</li>
<li>性能分析：通过Sleuth可以很方便的看出每个采集请求的耗时，分析出哪些服务调用比较耗时，当服务调用的耗时随着请求量的增大而增大时，也可以对服务的扩容提供一定的提醒作用；</li>
<li>数据分析，然后优化链路：对于频繁地调用一个服务，或者并行地调用等，可以针对业务做一些优化措施；</li>
<li>可视化：对于程序未捕获的异常，可以在zipkpin界面上看到。</li>
</ul>
</li>
<li>基本概念：<ul>
<li><code>Span</code>：基本工作单元，发送一个远程调度任务就会产生一个Span，Span是一个64位ID唯一标识的，Trace是用另一个64位ID唯一标识的；Span还有其他数据信息。<code>如，摘要、时间戳事件、Span的ID、以及进度ID</code>；</li>
<li><code>Trace</code>：一系列Span组成的一个树状结构。请求一个微服务系统的API接口，这个API接口，需要调用多个微服务，调用每个微服务都会产生一个新的Span，所有由这个请求产生的Span组成了这个Trace；</li>
<li><code>Annotation</code>：用来及时记录一个事件的，一些核心注解用来定义一个请求的开始和结束 。这些注解包括以下：<ul>
<li>cs - Client Sent：客户端发送一个请求，这个注解描述了这个Span的开始；</li>
<li>sr - Server Received：服务端获得请求并准备开始处理它，如果将其sr减去cs时间戳便可得到网络传输的时间；</li>
<li>ss - Server Sent(服务端发送响应)：该注解表明请求处理的完成(当请求返回客户端)，如果ss的时间戳减去sr时间戳，就可以得到服务器请求的时间；</li>
<li>cr - Client Received(客户端接收响应)：此时Span的结束，如果cr的时间戳减去cs时间戳便可以得到整个请求所消耗的时间。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>在Spring Cloud Sleuth中集成Zipkin非常的简单，只需要引入相应的依赖和做相关的配置即可。</p>
<ul>
<li><p>构建zipkin服务端：</p>
<ul>
<li><p>在spring Cloud为Finchley版本时，如果只需要默认的实现，则不需要自己构建Zipkin Server了，只需要下载jar即可，下载地址为：<code>https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/</code>；</p>
</li>
<li><p>下载完成后，将JAR包放入你自定义的目录下，然后在当前目录下，打开CMD，通过以下命令启动服务，默认INFO级别可以不设置logging：</p>
<p><code>java -jar 你下载的zipkin的JAR包 --logging.level.zipkin2=INFO</code>；</p>
</li>
<li><p>服务启动后默认可以通过9411端口访问zipkin的监控页面：<code>localhost:9411</code>。</p>
<p><img src="./Image-spc34.png" srcset="/img/loading.gif" alt="image-20200722135840122"></p>
</li>
</ul>
</li>
<li><p>然后，在需要使用Zipkin的项目中，引入Zipkin对应的依赖；我这里是以8001子项目为例，所以就导入到了8001子项目中；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--包含了sleuth+zipkin--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-payment-service</span>
  <span class="hljs-comment">#这里配置zipkin  </span>
  <span class="hljs-attr">zipkin:</span>
    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411</span>  <span class="hljs-comment">#表示将跟踪链放到zipkin的可视化工具上以方便查看</span>
  <span class="hljs-attr">sleuth:</span>
    <span class="hljs-attr">sampler:</span>
    <span class="hljs-attr">probability:</span> <span class="hljs-number">1</span>  <span class="hljs-comment">#这里取值一般是0-1之间，即0、0.5、1，1表示收集全部的跟踪链</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.gjt.mm.mysql.Driver</span>
    <span class="hljs-attr">url:</span> 
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> 

<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapperLocations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.atguigu.springcloud.entities</span>


<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span>  <span class="hljs-comment">#集群版</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">payment8001</span>
    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span></code></pre>
</li>
<li><p>在微服务提供方8001子项目中添加一个测试方法：</p>
<pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/payment/zipkin"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">paymentZipkin</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">"hi, 我是zipkin"</span>;
&#125;</code></pre>
</li>
<li><p>微服务提供方配置完成后，再配置调用方8100子项目，同样的，引入依赖；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--包含了sleuth+zipkin--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
 
<span class="hljs-attr">spring:</span>
    <span class="hljs-attr">application:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-order-service</span>
    <span class="hljs-attr">zipkin:</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411</span>
    <span class="hljs-attr">sleuth:</span>
      <span class="hljs-attr">sampler:</span>
        <span class="hljs-attr">probability:</span> <span class="hljs-number">1</span>
 
<span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-comment">#表示是否将自己注册进EurekaServer默认为true。</span>
    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span>
    <span class="hljs-comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">service-url:</span>
      <span class="hljs-comment">#单点</span>
      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span>
      <span class="hljs-comment"># 集群</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></code></pre>
</li>
<li><p>添加一个测试方法去调用8001子项目微服务；</p>
<pre><code class="hljs java"><span class="hljs-comment">//zipkin+sleuth</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/payment/zipkin"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">paymentZipkin</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    String result = restTemplate.getForObject(<span class="hljs-string">"http://localhost:8001"</span>+<span class="hljs-string">"/payment/zipkin/"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> result;
&#125;</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="Lesson3-微服务进阶"><a href="#Lesson3-微服务进阶" class="headerlink" title="Lesson3 微服务进阶"></a>Lesson3 微服务进阶</h2><h3 id="NO3-1-SpringCloud-Alibaba简介"><a href="#NO3-1-SpringCloud-Alibaba简介" class="headerlink" title="NO3.1 SpringCloud Alibaba简介"></a>NO3.1 SpringCloud Alibaba简介</h3><ul>
<li>SpringCloud Alibaba：<ul>
<li>介绍：Spring Cloud for Alibaba，它是由一些阿里巴巴的开源组件和云产品组成的。依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里微服务解决方案，通过阿里中间件来迅速搭建分布式应用系统；</li>
<li>功能：<ul>
<li><code>服务限流降级</code>：默认支持Servlet、Feign、RestTemplate、Dubbo和RocketMQ限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控；</li>
<li><code>服务注册与发现</code>：适配 SpringCloud 服务注册与发现标准，默认集成了 Ribbon的支持。</li>
<li><code>分布式配置管理</code>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><code>消息驱动能力</code>：基于 SpringCloudStream 为微服务应用构建消息驱动能力。</li>
<li><code>阿里云对象存储</code>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li><code>分布式任务调度</code>：提供秒级、精准、高可靠、高可用的定时(基于 Cron 表达式)任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker(schedulerx-client)上执行；</li>
</ul>
</li>
<li>组件：<ul>
<li><code>Sentinel</code>：面向分布式服务架构的轻量级流量控制产品，主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来帮助您保护服务的稳定性；</li>
<li><code>Nacos</code>：阿里巴巴推出来的一个新开源项目，这是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台；</li>
<li><code>RocketMQ</code>：分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务；</li>
<li><code>Alibaba Cloud ACM</code>：一款在分布式架构环境中对应用配置进行集中管理和推送的应用配置中心产品；</li>
<li><code>Alibaba Cloud OSS</code>：阿里云对象存储服务(Object Storage Service，简称 OSS)，是阿里云提供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据；</li>
<li><code>Alibaba Cloud SchedulerX</code>：阿里中间件团队开发的一款分布式任务调度产品，提供秒级、精准、高可靠、高可用的定时(基于 Cron 表达式)任务调度服务。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO3-2-Nacos–服务注册、发现和配置中心"><a href="#NO3-2-Nacos–服务注册、发现和配置中心" class="headerlink" title="NO3.2 Nacos–服务注册、发现和配置中心"></a>NO3.2 Nacos–服务注册、发现和配置中心</h3><ul>
<li><p>Nacos：</p>
<ul>
<li><p>介绍：这是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。简单讲就是注册中心加配置中心的组合；另外，<code>Nacos支持AP和CP的切换，使用命令：curl -X PUT &#39;$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP&#39;</code>；</p>
</li>
<li><p>功能：</p>
<ul>
<li>服务发现和服务健康监测；</li>
<li>动态配置服务；</li>
<li>动态 DNS 服务；</li>
<li>服务及其元数据管理。</li>
</ul>
</li>
<li><p>安装：</p>
<ul>
<li><p>安装环境：JDK1.8、Maven环境；</p>
</li>
<li><p>去Nacos官网找到下载地址并下载，下载完成后，解压到自定义目录下即可；</p>
</li>
<li><p>进入到nacos目录下的bin文件中，双击startup.cmd，就可以启动nacos；启动完成后，访问<code>localhost:8848/nacos</code>，输入默认账号密码：<code>nacos(账号和密码都是nacos)</code>，访问后出现如下界面，表示nacos安装并启动成功。</p>
<p><img src="./Image-spc35.png" srcset="/img/loading.gif" alt="image-20200722175845790"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Nacos微服务提供者：</p>
<ul>
<li><p>首先，为了以后创建Nacos子项目的方便，我们需要先将SpringCloudAlibaba的依赖引入到父工程中；</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--spring cloud 阿里巴巴--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>然后，创建cloud-provider-nacos-payment9001子项目(以下简称9001子项目)，并导入需要依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-payment-provider</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置Nacos地址</span>

<span class="hljs-comment">#暴露要监控的服务</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">'*'</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosPayment9001</span> </span>&#123;
	
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(NacosPayment9001<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>最后，开启nacos和微服务，测试微服务是否注册进了nacos；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Nacos微服务消费者；</p>
<ul>
<li><p>创建cloud-consumer-nacos-order8104子项目(以下简称8104子项目)，并导入相应的依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8104</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-order-consumer</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>


<span class="hljs-attr">service-url:</span>
  <span class="hljs-attr">nacos-user-service:</span> <span class="hljs-string">http://nacos-payment-provider</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController8104</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(OrderController8104<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置config和controller；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfiguration</span> </span>&#123;

	<span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@LoadBalanced</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRt</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();
	&#125;
&#125;

<span class="hljs-comment">//----------------------------------</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> RestTemplate rt;

	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;service-url.nacos-user-service&#125;"</span>)
	<span class="hljs-keyword">private</span> String st;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/nacos/get"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;

		rt.getForObject(st+<span class="hljs-string">"/nacos/get"</span>,String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>最后，开启微服务进行测试即可；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Nacos配置中心配置；</p>
<ul>
<li><p>创建子项目，并导入相应的依赖，主要就是添加nacos和naocs-config的依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- nacos config--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置两个yml文件：bootstrap.yml、application.yml；</p>
<pre><code class="hljs yml"><span class="hljs-comment">#这是bootstrap.yml</span>

<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3377</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#服务注册中心地址</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置中心地址</span>
        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment">#意思就是去配置中心里，读取后缀名为yaml配置文件为公共配置，具体是哪个文件，需要参照spring.profiles.active配置</span>


<span class="hljs-string">//-----------------------------------------</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosConfig3377</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(NacosConfig3377<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller；</p>
<pre><code class="hljs less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RefreshScope</span>  <span class="hljs-comment">//实现自动刷新</span>
public class ConfigController &#123;


	<span class="hljs-variable">@Value</span>(<span class="hljs-string">"$&#123;config.info&#125;"</span>)
	private String config;

	<span class="hljs-variable">@GetMapping</span>
	public String getConfig()&#123;
		<span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">config</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>然后，配置一下要从Nacos的配置中心拉取的公共配置文件，说白了就是你自己要在当前的项目配置文件中配置要从Nacos配置中心拉取的配置文件信息。以下是Nacos的配置中心里，想要拉取指定配置文件的配置解析；</p>
<p><img src="./Image-spc36.png" srcset="/img/loading.gif" alt="image-20200723144633438"></p>
</li>
<li><p>然后在Nacos配置中心创建一个公共配置文件即可，作用就是以便让子项目拉取公共配置环境信息；</p>
</li>
<li><p>上面两步配置完成后，开启3377子项目，测试是否能从Nacos配置中心拉取指定的配置信息；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Nacos的NameSpace(命名空间)、GroupId(组id)、DataId(具体配置文件id)：这三者的概念，其实就是为了更好的划分和整理配置文件；</p>
<ul>
<li><p>三者的概念：</p>
<ul>
<li>NameSpace(命名空间)：这是最大的配置隔离。<code>如，我有个分布式项目，改项目下有三个子项目微服务，配置文件主要有dev、prod，也就是开发环境和生成环境，那么命名空间就可以设置两个</code>；</li>
<li>GroupId(组id)：这是中等的配置隔离。<code>如，上面的分布式项目中有三个子项目微服务，那么就可以分别以这三个微服务分别建立不同的配置组：shopping组、order组、payment组；</code></li>
<li>DataId(具体配置文件id)：这是最小的配置隔离。<code>如，我负责order微服务，那么我就需要在dev或prod命名空间中的order组下拉取公共配置信息</code>。</li>
</ul>
</li>
<li><p>在项目中配置使用DataId、GroupId、NameSpace：</p>
<ul>
<li><p>拉取不同的DataId配置文件；</p>
<ul>
<li><p>在Nacos配置中心，创建另一个nacos-config-client-prod.yaml公共配置文件；</p>
<p><img src="./Image-spc37.png" srcset="/img/loading.gif" alt="image-20200723155017843"></p>
</li>
<li><p>然后，只要配置application.yml中的spring.profiles.active属性即可；</p>
<pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">prod</span></code></pre>
</li>
<li><p>开启微服务测试是否能读取另一个DataId下的配置信息。</p>
</li>
</ul>
</li>
<li><p>拉取不同的GroupId配置文件；</p>
<ul>
<li><p>在Nacos配置中心，创建另一个nacos-config-client-prod2.yaml公共配置文件，且GroupId为123；</p>
<p><img src="./Image-spc38.png" srcset="/img/loading.gif" alt="image-20200723160148538"></p>
</li>
<li><p>然后，只要在bootstrap.yml文件中配置一个group属性即可；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3377</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#服务注册中心地址</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置中心地址</span>
        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment">#意思就是去配置中心里，读取后缀名为yaml配置文件为公共配置，具体是哪个文件，需要参照spring.profiles.active配置</span>
        <span class="hljs-comment">#配置读取哪一个GroupId下的配置文件</span>
        <span class="hljs-attr">group:</span> <span class="hljs-number">123</span>

<span class="hljs-string">//----------------------------------</span>

<span class="hljs-comment">#由于我在123组中创建了另一个配置文件，所以spring.profiles.active属性也需要修改一下</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">prod2</span></code></pre>
</li>
<li><p>开启微服务，测试是否能读取另一个GroupId里指定DataId的配置文件信息。</p>
</li>
</ul>
</li>
<li><p>拉取不同的NameSpace里的配置文件；</p>
<ul>
<li><p>在Nacos配置中心，创建命名空间为myspace，创建另一个nacos-config-client-prod3.yaml公共配置文件，且GroupId为456；</p>
<p><img src="./Image-spc40.png" srcset="/img/loading.gif" alt="image-20200723161750831"></p>
</li>
<li><p>然后，只需要在bootstrap.yml文件中配置一个namespace属性即可，但是要注意，这里的namespace属性，写的是在Nacos创建命名空间时的那个命名空间ID，这个ID在创建命名空间时，你可以自定义，也可以让Nacos帮你随机定义；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3377</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-config-client</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#服务注册中心地址</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置中心地址</span>
        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment">#意思就是去配置中心里，读取后缀名为yaml配置文件为公共配置，具体是哪个文件，需要参照spring.profiles.active配置</span>
        <span class="hljs-comment">#配置读取哪一个GroupId下的配置文件</span>
        <span class="hljs-attr">group:</span> <span class="hljs-number">456</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">f402e2c0-c789-4164-b8f2-4cd1f843f696</span>

<span class="hljs-string">//----------------------------------</span>

<span class="hljs-comment">#由于我在123组中创建了另一个配置文件，所以spring.profiles.active属性也需要修改一下</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">prod3</span></code></pre>
</li>
<li><p>开启微服务，测试是否能读取另一个GroupId里指定DataId的配置文件信息。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Nacos集群和持久化配置：</p>
<ul>
<li><p>想一想，为什么我们关闭了Nacos后，再开启Nacos，我们之前创建的服务配置为什么还能够在Nacos中显示？那是因为Nacos默认自带的是嵌入式数据库derby，所以会将配置信息存入这个数据库。也就是说，如果Nacos进行了集群化部署，那么每一个Nacos中的数据都存入本身Nacos自带的derby嵌入式数据库，这就不利于集群化部署的数据一致性了，通俗的说就是多个Nacos的数据不一致了。所以Nacos采用了集中式存储的方式来支持集群化部署，就是将所有的Nacos的数据都存入一个数据库中，但目前只支持MySQL的存储；</p>
</li>
<li><p>持久化配置，上面也说了，就是将Nacos的配置的数据信息，从本身derby转为MySQL数据库，换句话说，就是原本存在derby的数据，我想以后存在MySQL；配置如下(Windows环境下)：</p>
<ul>
<li><p>安装MySQL，版本必须为5.6.5以上；</p>
</li>
<li><p>在MySQL中创建一个名为<code>nacos_config</code>数据库(必须是这个名称)，创建之后，在Nacos所在的目录中找到conf目录，并在conf目录下找到一个名为<code>nacos-mysql.sql</code>的文件，这个文件就是用于在MySQL创建表所使用的，这些表用于存储Nacos中的那些配置信息；找到<code>nacos-mysql.sql</code>文件后，将里面的内容全部复制到MySQL中进行执行即可，记住不要去修改里面的任何东西；执行成功后，得到以下数据库目录；</p>
<p><img src="./Image-spc41.png" srcset="/img/loading.gif" alt="image-20200723174019909"></p>
</li>
<li><p>然后，同样在conf目录下找到另一个文件application.properties，这个配置文件就是用于配置Nacos，也就是说，我们现在要告诉Nacos，以后把你的数据信息，都存入MySQL，而不是存入derby中。在application.properties配置文件的最下方，添加一下配置：</p>
<pre><code class="hljs properties"><span class="hljs-comment">#告诉Nacos，以后数据信息都存入MySQL，而不是存入derby</span>
<span class="hljs-meta">spring.datasource.platform</span>=<span class="hljs-string">mysql</span>
 
<span class="hljs-meta">db.num</span>=<span class="hljs-string">1</span>
<span class="hljs-meta">db.url.0</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span>
<span class="hljs-meta">db.user</span>=<span class="hljs-string">root</span>
<span class="hljs-meta">db.password</span>=<span class="hljs-string">你的mysql数据库密码</span></code></pre>
</li>
<li><p>到此，Nacos的持久化配置就配置完成，关闭Nacos，重新打开Nacos，会发现之前配置的配置信息都没了，这就表示数据持久化的配置，成功从derby转移到了mysql数据库。</p>
</li>
</ul>
</li>
<li><p>另外Linux环境下的这些配置，也和Windows环境下差不多；</p>
<ul>
<li><p>分别下载并安装nacos、mysql5.7、nginx到linux中；</p>
</li>
<li><p>配置nacos的数据持久化：即nacos的数据信息从derby数据库转移到mysql数据库；以及告知nacos以后往mysql中存数据，也就是修改application.properties配置文件。这一步和Windows一样，细节就不做过多叙述；</p>
</li>
<li><p>然后，复制conf目录中的<code>cluster.conf.example</code>文件，粘贴为一个新的文件，文件名自定义(我一般自定义为<code>cluster.conf</code>)，并往该新文件写入以下内容：</p>
<pre><code class="hljs accesslog">#也就是说，我打算在这台Linux中开启多个Nacos(也就是集群)，注意这里的ip不能写<span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>，千万不要写这个哦，你可以使用hostname -i命令或其他命令查看本机的ip
你自己的linux的ip地址:端口号

如：
<span class="hljs-number">192.168.111.144:3333</span>
<span class="hljs-number">192.168.111.144:4444</span>
<span class="hljs-number">192.168.111.144:5555</span></code></pre>
</li>
<li><p>再来，需要修改nacos目录下bin目录中的<code>startup.sh</code>文件，让这个命令支持一个脚本功能，即输入：<code>./startup.sh -p 3333</code>，达到效果：在3333端口启动nacos，且改变<code>-p</code>后面的参数，就以不同端口启动nacos；所以，首先要复制<code>startup.sh</code>文件，粘贴为一个新的文件，文件名自定义(我自定义为startup.sh.bk)，并进行两步修改(这里涉及shell编程)：</p>
<ul>
<li><p>第一步修改这里：</p>
<p><img src="./Image-spc43.png" srcset="/img/loading.gif" alt="image-20200723183402131"></p>
</li>
<li><p>第二步修改这里：也就是添加这么一串命令：<code>- Dserver.port=${PORT}</code>。</p>
<p><img src="./Image-spc42.png" srcset="/img/loading.gif" alt="image-20200723184102318"></p>
</li>
</ul>
</li>
<li><p>最后就是修改nginx，进行负载均衡配置。找到nginx目录下的nginx.conf配置文件，同样复制该文件，粘贴为一个新的文件，新文件的文件名自定义即可，然后在这个新文件中配置负载均衡，如下图所示：</p>
<p><img src="./Image-spc44.png" srcset="/img/loading.gif" alt="image-20200723185422284"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO3-3-Sentinel–服务的降级、熔断、限流"><a href="#NO3-3-Sentinel–服务的降级、熔断、限流" class="headerlink" title="NO3.3 Sentinel–服务的降级、熔断、限流"></a>NO3.3 Sentinel–服务的降级、熔断、限流</h3><ul>
<li><p>Sentinel：</p>
<ul>
<li><p>介绍：Sentinel是面向分布式服务框架的轻量级流量控制框架，主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来维护系统的稳定性；简单讲，就是和Hystrix本质差不多，但是功能上更完备的一个服务流量框架；</p>
</li>
<li><p>核心功能：</p>
<ul>
<li>流量控制；</li>
<li>熔断降级；</li>
<li>系统负载保护(防止系统雪崩)等等。</li>
</ul>
</li>
<li><p>安装与启动：</p>
<ul>
<li><p>Sentinel分为两个部分：即核心库和控制台；</p>
<ul>
<li>核心库：不依赖任何框架/库，能够运行于所有Java运行时环境，同时对Dubbo、SpringCloud等框架也有较好的支持；</li>
<li>控制台：即Dashboard，是基于SpringBoot开发的，打包后可以直接运行，不需要额外的Tomcat等应用容器。</li>
</ul>
</li>
<li><p>下载完成后的Sentinel就是一个JAR包，然后将该JAR包放入自定义目录下即可，进入Sentinel目录，使用命令行命令：<code>java -jar sentinel.jar</code>，即可启动Sentinel，然后访问<code>localhost:8080</code>，并输入：sentinel(账号和密码都是sentinel)，出现如下界面，表示Sentinel已经成功启动了。</p>
<p><img src="./Image-spc45.png" srcset="/img/loading.gif" alt="image-20200723211942847"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel监控微服务；</p>
<ul>
<li><p>创建cloud-sentinel-service8401子项目(以下简称8401子项目)，并导入相应依赖；8401子项目就是测试监控用的微服务；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba sentinel-datasource-nacos 持久化需要用到--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba sentinel--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8401</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloudalibaba-sentinel-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
    <span class="hljs-attr">sentinel:</span>
      <span class="hljs-attr">transport:</span>
        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">8719</span>  <span class="hljs-comment">#sentinel占用的端口，默认是8719，假如被占用了会自动从8719开始依次+1扫描，直至找到未被占用的端口</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">'*'</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelService8401</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(SentinelService8401<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelController</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testa"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">testA</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"testA"</span>;
	&#125;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testb"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">testB</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"testB"</span>;
	&#125;

&#125;</code></pre>
</li>
<li><p>开启8401微服务、Nacos、Sentinel，测试Sentinel是否有监控到8401微服务；测试成功如下所示。</p>
<p><img src="./Image-spc46.png" srcset="/img/loading.gif" alt="image-20200723214519464"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel服务限流(即流量控制规则)；</p>
<ul>
<li><p>定义：流量控制(flow control)，其原理是监控应用流量的QPS或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性；</p>
</li>
<li><p>规则主要有三种：直接(默认)、关联和链路；</p>
<ul>
<li><p><code>直接流控模式</code>：即访问接口达到限流条件时，直接限流；</p>
<ul>
<li><p>直接+QPS：QPS为每秒的请求数；<code>如，我一秒钟狂点十几下，那就是十几个请求数，远远超过了阈值：1，所以就直接报错</code>；</p>
<p><img src="./Image-spc48.png" srcset="/img/loading.gif" alt="image-20200724000014606"></p>
</li>
<li><p>直接+线程数：表示处理请求的方法，一次只能处理一个请求线程，且在当前请求线程未处理完成时，又有请求线程进来的话，就会直接报错；</p>
<p><img src="./Image-spc49.png" srcset="/img/loading.gif" alt="image-20200723235755107"></p>
</li>
</ul>
</li>
<li><p><code>关联流控模式</code>：当关联的资源达到阈值时，就限流自己；</p>
<ul>
<li><p>关联+QPS：</p>
<p><img src="./Image-spc50.png" srcset="/img/loading.gif" alt="image-20200724001659111"></p>
</li>
<li><p>关联+线程数：这里就不演示这个了，和直接+线程数效果差不多；</p>
</li>
</ul>
</li>
<li><p><code>链路流控模式</code>：即请求从指定的入口资源进来时，如果达到阈值，就会限流；</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>流控效果：</p>
<ul>
<li><p><code>直接</code>：即一旦限流，就直接返回错误信息；</p>
</li>
<li><p><code>预热</code>： 即让低流量的微服务，在遇到高峰访问时，不至于雪崩，慢慢的放出访问数，达到预热时长后，才会达到阈值。主要是用来防止流量的突然上升，使系统本在稳定状态下能处理的请求；默认冷加载因子为3，即最开始能处理的请求为<code>阈值/3</code>。<code>如，阈值是100，那么初始能处理的请求为100/3 = 33个左右，经过预热时间后，就能够上升到100</code>；</p>
<p><img src="./Image-spc51.png" srcset="/img/loading.gif" alt="image-20200724012001265"></p>
</li>
<li><p><code>排队等待</code>：即匀速排队，让请求以匀速的速度通过，阈值类型必须设置为QPS，否则无效；另外如果请求过了设置的超时时间都还没有被处理的话，那么请求将会被丢弃；</p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel服务降级规则：</p>
<ul>
<li><p><code>RT</code>：即平均响应时间，也就是说当1s内持续进入5个请求，对应时刻的平均响应时间(秒级)均超过阈值(count，以ms为单位)，那么在接下来的时间窗口之内，对这个方法的调用都会自动地熔断(抛出 DegradeException异常)；</p>
<p><img src="./Image-spc54.png" srcset="/img/loading.gif" alt="image-20200724151030722"></p>
</li>
<li><p><code>异常比例</code>：当资源的每秒请求量 &gt;= 5，并且每秒异常总数占通过量的比值超过阈值之后，资源进入降级状态；</p>
<p><img src="./Image-spc55.png" srcset="/img/loading.gif" alt="image-20200724151319832"></p>
</li>
<li><p><code>异常数</code>：当资源近1分钟的异常数目超过阈值之后会进行熔断。</p>
<p><img src="./Image-spc56.png" srcset="/img/loading.gif" alt="image-20200724152054442"></p>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel热点规则；</p>
<ul>
<li><p>定义：热点就是经常访问的数据，而热点规则就是对经常访问的数据进行一个限流的意思；</p>
</li>
<li><p>使用：</p>
<ul>
<li><p>首先，使用热点规则，需要@SentinelResource注解的配合使用，该注解的作用是标记需要使用热点规则的方法；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelController</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testa"</span>)
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"ta"</span>,blockHandler = <span class="hljs-string">"methoda"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">testA</span><span class="hljs-params">(@RequestParam(value = <span class="hljs-string">"d"</span>,required = <span class="hljs-keyword">false</span>)</span> String a)</span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"aaa"</span>;
	&#125;


 	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">methoda</span><span class="hljs-params">(String a, BlockException be)</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"ccccc"</span> + be;
	&#125;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testb"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">testB</span><span class="hljs-params">()</span></span>&#123;

<span class="hljs-comment">//		return ms.getMess();</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"bbb"</span>;
	&#125;

&#125;</code></pre>

<ul>
<li>blockHandler：该属性的值指向的是一个方法，用于处理BlockException。要求：<ul>
<li>必须是<code>public</code>；</li>
<li>返回类型与原方法一致；</li>
<li>参数类型需要和原方法相匹配，并在最后加<code>BlockException</code>类型的参数；</li>
<li>默认需和原方法在同一个类中。若希望使用其他类的函数，可配置 <code>blockHandlerClass</code> ，并指定blockHandlerClass里面的方法。</li>
</ul>
</li>
</ul>
</li>
<li><p>然后，Sentinel的Dashboard中配置热点规则；</p>
<p><img src="./Image-spc57.png" srcset="/img/loading.gif" alt="image-20200724173008471"></p>
</li>
</ul>
</li>
<li><p>参数例外项：</p>
<ul>
<li><p>含义：顾名思义，对限流中的某些特殊值，进行特殊的限制。<code>如，限流了a参数，无论是什么值，只要QPS达到了阈值1，那么就会限流报异常，从而调用blockHandler属性指定的方法，但是我希望a参数的值为5的时候，可以放宽阈值，希望阈值能到200，那么这个时候就需要使用参数例外项了</code>；</p>
<p><img src="./Image-spc58.png" srcset="/img/loading.gif" alt="image-20200724182802658"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Sentinel系统规则；<ul>
<li>定义：针对整个应用而言的一些限流设置；</li>
<li>规则：<ul>
<li><code>LOAD</code>：只有在 Linux 系统的机器上才会生效，可以根据当前操作系统的负载，来决定是否触发保护(把请求拒绝掉)；</li>
<li><code>RT</code>：这个应用上，所有请求的平均响应时间，如果超过某个值，就停止新的请求；</li>
<li><code>线程数</code>：这个应用上，所有的请求消耗的线程数加起来，如果超过某个值，就停止新的请求；</li>
<li><code>入口QPS</code>：这个应用上，所有接口的 QPS 加起来，如果超过某个值，就停止新的请求；</li>
<li><code>CPU使用率</code>：CPU 的使用率，如果超过一个百分比，就停止新的请求；</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel服务降级；</p>
<ul>
<li><p>按资源名称限流：即按@SentinelResource注解中的value属性进行限流，进行限流后，如果超出阈值，那么会触发BlockException，如果想要使用自己定义的处理方法来处理该异常的话，就需要用的@SentinelResource注解了：</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelController2</span> </span>&#123;


	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testa2"</span>)
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"ta2"</span>,blockHandler = <span class="hljs-string">"methoda2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">testA</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"成功了"</span>,<span class="hljs-keyword">new</span> Payment(<span class="hljs-number">1l</span>,<span class="hljs-string">"222"</span>));
	&#125;

	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">methoda2</span><span class="hljs-params">(BlockException be)</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"nothing"</span>);
	&#125;
&#125;

说明：使用<span class="hljs-meta">@SentinelResource</span>注解的方法，如果出现BlockException异常时，就会根据注解中的blockHandler属性去找对应的处理方法，如果有对应的处理方法就调用；如果没有对应的处理方法，就会调用Sentinel默认的处理方法。</code></pre>

<p><img src="./Image-spc59.png" srcset="/img/loading.gif" alt="image-20200724221848215"></p>
</li>
<li><p>按Url地址限流：即按@GetMapping注解里的value属性进行限流；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelController2</span> </span>&#123;


	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testa2"</span>)  
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"ta2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">testA</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"成功了"</span>,<span class="hljs-keyword">new</span> Payment(<span class="hljs-number">1l</span>,<span class="hljs-string">"222"</span>));
	&#125;

	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">methoda2</span><span class="hljs-params">(BlockException be)</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"nothing"</span>);
	&#125;
&#125;

说明：按Url地址进行限流，其实就是按<span class="hljs-meta">@GetMapping</span>注解里的value属性进行限流，出现BlockException异常时，一般都默认调用Sentinel的处理方法。</code></pre>

<p><img src="./Image-spc60.png" srcset="/img/loading.gif" alt="image-20200724222644185"></p>
<p><img src="./Image-spc61.png" srcset="/img/loading.gif" alt="image-20200724222741050"></p>
</li>
<li><p>自定义处理类，处理BlockException；</p>
<ul>
<li><p>问题：上面提到的按资源名称或按Url地址进行限流的处理方法，虽然好是好，但是一旦方法越来越多，那么Controller里的代码每个对应的方法都要写一个针对BlockException的处理方法，那么这样会使得代码耦合性越来越高；</p>
</li>
<li><p>解决：自定义处理类，处理BlockException；</p>
<ul>
<li><p>首先自定义一个MyHandler全局类，该类就是专门用来存放处理BlockException异常的方法的类：<strong><code>注意：这里面的方法都要用static来修饰。</code></strong></p>
<pre><code class="hljs java"><span class="hljs-comment">//创建一个全局类来存放专门处理BlockException异常方法的类</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHandler</span> </span>&#123;

	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommonResult <span class="hljs-title">methoda2</span><span class="hljs-params">(BlockException be)</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"nothing"</span>);
	&#125;
&#125;</code></pre>
</li>
<li><p>然后，controller中，就只管调用方法即可，如果一旦需要调用处理BlockException异常的方法，就在@SentinelResource注解中，添加blockHandlerClass属性和blockHandler属性；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SentinelController2</span> </span>&#123;


	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/testa2"</span>)
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"ta2"</span>, blockHandlerClass = MyHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">blockHandler</span> </span>= <span class="hljs-string">"methoda2"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">testA</span><span class="hljs-params">()</span></span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">404</span>,<span class="hljs-string">"成功了"</span>,<span class="hljs-keyword">new</span> Payment(<span class="hljs-number">1l</span>,<span class="hljs-string">"222"</span>));
	&#125;

&#125;

说明：<span class="hljs-meta">@SentinelResource</span>注解中的blockHandlerClass属性表示，告知Sentinel，让哪个类来处理BlockException异常；而blockHandler属性，则进一步指定了该类中具体处理BlockException异常的方法</code></pre>

</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel整合Ribbon的配置：</p>
<ul>
<li><p>创建cloud-provider-payment9003和9004子项目(以下分别简称9003、9004子项目)，并导入相应的依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringCloud ailibaba sentinel--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 引用自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.eiletxie.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--监控--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--热部署--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9003</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-payment-provider</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置Nacos地址</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">'*'</span>
        
<span class="hljs-string">//-----------------------------------------------</span>

<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9004</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-payment-provider</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#配置Nacos地址</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">'*'</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Payment9003</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(Payment9003<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;

<span class="hljs-comment">//-----------------------------------------------</span>

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Payment9004</span> </span>&#123;

	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(Payment9004<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置Controller；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentController</span> </span>&#123;

	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;server.port&#125;"</span>)
	<span class="hljs-keyword">private</span> String port;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/get"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"Nacos is ok"</span> + port;
	&#125;
&#125;

说明：<span class="hljs-number">9003</span>和<span class="hljs-number">9004</span>的controller一样，这里就只方了一个</code></pre>
</li>
<li><p>创建cloud-consumer-order8105子项目(以下简称8105子项目)，并导入相应依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dyf.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8105</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-order-consumer</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
    <span class="hljs-attr">sentinel:</span>
      <span class="hljs-attr">transport:</span>
        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">8719</span>

<span class="hljs-attr">service-url:</span>
  <span class="hljs-attr">nacos-user-service:</span> <span class="hljs-string">http://nacos-payment-provider</span></code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order8105</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(Order8105<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
		
	&#125;
&#125;</code></pre>
</li>
<li><p>配置Controller类和Configuration类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfiguration</span> </span>&#123;
	
	<span class="hljs-meta">@Bean</span>
	<span class="hljs-meta">@LoadBalanced</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRT</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();
	&#125;
&#125;

<span class="hljs-comment">//--------------------------</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> </span>&#123;

	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SERVICE_URL = 
        		<span class="hljs-string">"http://nacos-payment-provider"</span>;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> RestTemplate restTemplate;


	<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/consumer/fallback"</span>)
	<span class="hljs-comment">//@SentinelResource(value = "fallback") //没有配置</span>
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"fallback"</span>,fallback = <span class="hljs-string">"handlerFallback"</span>) <span class="hljs-comment">//fallback只负责业务异常</span>
	<span class="hljs-comment">//@SentinelResource(value = "fallback",blockHandler = "blockHandler") //blockHandler只负责sentinel控制台配置违规</span>
<span class="hljs-comment">//	@SentinelResource(value = "fallback",fallback = "handlerFallback",blockHandler = "blockHandler",</span>
<span class="hljs-comment">//			exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">fallback</span><span class="hljs-params">()</span> </span>&#123;

		<span class="hljs-keyword">int</span> a = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;

		String result = restTemplate.getForObject(SERVICE_URL + <span class="hljs-string">"/payment/"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;


		<span class="hljs-keyword">return</span> result;
	&#125;

	<span class="hljs-comment">//fallback</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handlerFallback</span><span class="hljs-params">(Throwable e)</span> </span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"这里是fallback方法"</span>;
	&#125;

	<span class="hljs-comment">//blockHandler</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">blockHandler</span><span class="hljs-params">(BlockException blockException)</span> </span>&#123;

		<span class="hljs-keyword">return</span> <span class="hljs-string">"这里是blockhandler方法"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>打开微服务，测试使用8105子项目调用9003和9004子项目，此时，一定会报出除数为0的异常，所以，需要使用@SentinelResource注解中的fallback属性来解决，该属性的作用是在抛出Java异常的时候提供fallback处理逻辑，也就是常说的友好提示功能，让用户访问体验更好；fallback属性的要求：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个Throwable 类型的参数用于接收对应的异常；</li>
<li>fallback调用的方法默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定fallbackClass为对应的类的Class对象，注意对应的函数必需为static函数，否则无法解析。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel整合OpenFeign的配置；</p>
<ul>
<li><p>基于8105、9003、9004三个子项目进行测试，一般OpenFeign都用在消费端。所以，这里需要对8105子项目(当然，需要先引入对应的OpenFeign依赖)的yml文件进行配置；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8105</span>


<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-order-consumer</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
    <span class="hljs-attr">sentinel:</span>
      <span class="hljs-attr">transport:</span>
        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">8719</span>

<span class="hljs-attr">service-url:</span>
  <span class="hljs-attr">nacos-user-service:</span> <span class="hljs-string">http://nacos-payment-provider</span>
  
<span class="hljs-comment">#激活Sentinel对OpenFeign</span>
<span class="hljs-attr">feign:</span>
  <span class="hljs-attr">sentinel:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span></code></pre>
</li>
<li><p>添加注解到8105启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@EnableFeignClients</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order8105</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;
		SpringApplication.run(Order8105<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;

	&#125;
&#125;</code></pre>
</li>
<li><p>配置OpenFeign接口和产生超时异常时调用的fallback方法类；</p>
<pre><code class="hljs java"><span class="hljs-comment">//OpenFeign接口</span>

<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"nacos-payment-provider"</span>,fallback = FeignServiceImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">interface</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/payment"</span>)  <span class="hljs-comment">//调用9003或9004微服务的url资源：payment</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">myFeign</span><span class="hljs-params">()</span></span>;

&#125;

<span class="hljs-comment">//----------------------------</span>

<span class="hljs-comment">//OpenFeign接口的实现类：即产生异常时专门用于调用fallback方法的类</span>

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeignService</span> </span>&#123;

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">myFeign</span><span class="hljs-params">()</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">"这是Sentinel整合OpenFeign的fallback方法"</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> FeignService feignService;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/consumer/fallback"</span>)
	<span class="hljs-meta">@SentinelResource</span>(value = <span class="hljs-string">"fallback"</span>,
	blockHandler = <span class="hljs-string">"blockHandler"</span>) <span class="hljs-comment">//blockHandler只负责sentinel控制台配置违规</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">fallback</span><span class="hljs-params">()</span> </span>&#123;

		<span class="hljs-keyword">return</span> feignService.myFeign();
	&#125;

&#125;</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Sentinel将规则持久化进Nacos；</p>
<ul>
<li><p>问题：在公司项目中，我们会使用Sentinel对某些服务进行流控、热点、降级等规则，但是一旦重启某个微服务以后，这些规则就又要重新配置一遍；</p>
</li>
<li><p>解决：使用Nacos来持久化Sentinel的规则，即将规则保存到Nacos的配置里，然后在微服务的yml中，配置使用哪个规则文件即可；</p>
<ul>
<li><p>首先，我们代开8401子项目，然后倒入持久化的重要依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>然后，配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8401</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cloudalibaba-sentinel-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#Nacos服务注册中心地址</span>
    <span class="hljs-attr">sentinel:</span>
      <span class="hljs-attr">transport:</span>
        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span> <span class="hljs-comment">#配置Sentinel dashboard地址</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">8719</span>
      <span class="hljs-comment">#配置使用Nacos中已经创建好的规则配置文件  </span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">ds1:</span>
          <span class="hljs-attr">nacos:</span>
            <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
            <span class="hljs-attr">dataId:</span> <span class="hljs-string">cloudalibaba-sentinel-service</span>
            <span class="hljs-attr">groupId:</span> <span class="hljs-string">DEFAULT_GROUP</span>
            <span class="hljs-attr">data-type:</span> <span class="hljs-string">json</span>
            <span class="hljs-attr">rule-type:</span> <span class="hljs-string">flow</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">'*'</span>

<span class="hljs-attr">feign:</span>
  <span class="hljs-attr">sentinel:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 激活Sentinel对Feign的支持</span></code></pre>
</li>
<li><p>打开Nacos的前台网站：<code>localhost:8848</code>，创建一个规则文件；</p>
<p><img src="./Image-spc62.png" srcset="/img/loading.gif" alt="image-20200725155536180"></p>
</li>
<li><p>最后，打开Sentinel，并启动8401微服务，访问一下8401微服务，再去Sentinel刷新一下，就可以看到上面配置的规则就自动有了。</p>
<p><img src="./Image-spc63.png" srcset="/img/loading.gif" alt="image-20200725160558285"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="NO3-4-Seata–分布式事务"><a href="#NO3-4-Seata–分布式事务" class="headerlink" title="NO3.4 Seata–分布式事务"></a>NO3.4 Seata–分布式事务</h3><ul>
<li><p>Seata：</p>
<ul>
<li><p>介绍：Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了AT(默认使用的是这个)、TCC、SAGA和XA事务模式，为用户打造一站式的分布式解决方案；</p>
</li>
<li><p>组件：</p>
<ul>
<li><code>TC(Transaction Coordinator)</code>：即事务协调者，维护全局和分支事务的状态，驱动全局事务提交或回滚；</li>
<li><code>TM(Transaction Manager)</code>：即事务管理器，定义全局事务的范围：开始全局事务、提交或回滚全局事务；</li>
<li><code>RM(Resource Manager)</code>：即资源管理器，管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
</li>
<li><p>原理：全局事务ID+三大组件模型：即全局事务ID+TC、TM、RM；</p>
<p><img src="./Image-spc64.png" srcset="/img/loading.gif" alt="image-20200725175003811"></p>
<ul>
<li>在Seata中，分布式事务的执行流程：<ul>
<li>TM开启分布式事务(TM向TC注册全局事务记录)；</li>
<li>按业务场景，编排数据库、服务等事务内资源(RM 向 TC 汇报资源准备状态)；</li>
<li>TM结束分布式事务，事务一阶段结束(TM通知TC提交/回滚分布式事务)；</li>
<li>TC汇总事务信息，决定分布式事务是提交还是回滚；</li>
<li>TC通知所有 RM 提交/回滚 资源，事务二阶段结束。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Seata安装与配置：</p>
<ul>
<li><p>安装：从官网上下载后，解压得到一个seata文件，将该文件放入自定义目录下即可；</p>
</li>
<li><p>配置：</p>
<ul>
<li><p>自定义事务组名称：进入seata目录，找到conf目录并进入，再找到<code>file.conf.example</code>文件，复制该文件，并粘贴为一个新的文件后，打开这个文件新的文件，找到service模块并配置事务组名称；</p>
<p><img src="./Image-spc65.png" srcset="/img/loading.gif" alt="image-20200725182026670"></p>
</li>
<li><p>配置事务日志存储模式和数据库连接信息：接着上面的，在上面打开的文件中，再找到store模块，并配置事务日志的存储模式及数据库连接信息；下面配置完成后，记得在数据库中创建自己自定义的数据库；</p>
<p><img src="./Image-spc66.png" srcset="/img/loading.gif" alt="image-20200725182710701"></p>
</li>
<li><p>在自己自定义的数据库中建表；使用到的建表语句在seata目录下的conf中，文件是db_store.sql，但是要注意，1.0版本以后就没有了这个文件，要么上网找，要么看看本目录中的README.md文件里有没有地址提示；这里也贴出来我找到的建表的sql语句：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> <span class="hljs-string">`global_table`</span>;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-string">`global_table`</span> (
  <span class="hljs-string">`xid`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-string">`transaction_id`</span> <span class="hljs-built_in">bigint</span>,
  <span class="hljs-string">`status`</span> <span class="hljs-built_in">tinyint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-string">`application_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>),
  <span class="hljs-string">`transaction_service_group`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>),
  <span class="hljs-string">`transaction_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>),
  <span class="hljs-string">`timeout`</span> <span class="hljs-built_in">int</span>,
  <span class="hljs-string">`begin_time`</span> <span class="hljs-built_in">bigint</span>,
  <span class="hljs-string">`application_data`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">2000</span>),
  <span class="hljs-string">`gmt_create`</span> datetime,
  <span class="hljs-string">`gmt_modified`</span> datetime,
  primary <span class="hljs-keyword">key</span> (<span class="hljs-string">`xid`</span>),
  <span class="hljs-keyword">key</span> <span class="hljs-string">`idx_gmt_modified_status`</span> (<span class="hljs-string">`gmt_modified`</span>, <span class="hljs-string">`status`</span>),
  <span class="hljs-keyword">key</span> <span class="hljs-string">`idx_transaction_id`</span> (<span class="hljs-string">`transaction_id`</span>)
);


<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> <span class="hljs-string">`branch_table`</span>;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-string">`branch_table`</span> (
  <span class="hljs-string">`branch_id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-string">`xid`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-string">`transaction_id`</span> <span class="hljs-built_in">bigint</span> ,
  <span class="hljs-string">`resource_group_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>),
  <span class="hljs-string">`resource_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) ,
  <span class="hljs-string">`lock_key`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>) ,
  <span class="hljs-string">`branch_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">8</span>) ,
  <span class="hljs-string">`status`</span> <span class="hljs-built_in">tinyint</span>,
  <span class="hljs-string">`client_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>),
  <span class="hljs-string">`application_data`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">2000</span>),
  <span class="hljs-string">`gmt_create`</span> datetime,
  <span class="hljs-string">`gmt_modified`</span> datetime,
  primary <span class="hljs-keyword">key</span> (<span class="hljs-string">`branch_id`</span>),
  <span class="hljs-keyword">key</span> <span class="hljs-string">`idx_xid`</span> (<span class="hljs-string">`xid`</span>)
);


<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> <span class="hljs-string">`lock_table`</span>;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-string">`lock_table`</span> (
  <span class="hljs-string">`row_key`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-string">`xid`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">96</span>),
  <span class="hljs-string">`transaction_id`</span> <span class="hljs-keyword">long</span> ,
  <span class="hljs-string">`branch_id`</span> <span class="hljs-keyword">long</span>,
  <span class="hljs-string">`resource_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) ,
  <span class="hljs-string">`table_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) ,
  <span class="hljs-string">`pk`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">36</span>) ,
  <span class="hljs-string">`gmt_create`</span> datetime ,
  <span class="hljs-string">`gmt_modified`</span> datetime,
  primary <span class="hljs-keyword">key</span>(<span class="hljs-string">`row_key`</span>)
);</code></pre>
</li>
<li><p>配置conf目录下的registry.conf文件；同样，复制registry.conf文件，粘贴为一个新的文件后并代开该文件，然后进行如下配置；</p>
<p><img src="./Image-spc67.png" srcset="/img/loading.gif" alt="image-20200725185737987"></p>
</li>
<li><p>这里要注意个问题，上面配置全部完成后，打开seata目录中的bin目录，双击<code>seata-server.bat</code>文件，如果出现闪退问题，按照一下方法解决：</p>
<ul>
<li><p>情况一：没有logs文件夹；你可以在bin目录中，使用cmd命令启动seata，如果出现下图情况，就是没有logs文件夹；说白了就是：找不到<code>logs/seata_gc.log文件</code>；</p>
<p><img src="./Image-spc68.png" srcset="/img/loading.gif" alt="image-20200725191413721"></p>
<ul>
<li>解决：在bin同级目录下新建logs文件夹，在logs中新建<code>seata_gc.log</code>文件；</li>
</ul>
</li>
<li><p>情况二：运行内存不够；如果有了logs目录和<code>seata_gc.log</code>文件后启动还闪退，那就有可能是运行内存不够的问题；</p>
<ul>
<li><p>解决：修改<code>seata-server.bat</code>文件的jvm内存配置，把它们都设置的小一点；</p>
<p><img src="./Image-spc69.png" srcset="/img/loading.gif" alt="image-20200725191926636"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>实例演示Seata：</p>
<ul>
<li><p>实例演示说明：下订单—&gt;扣库存—&gt;减余额；</p>
</li>
<li><p>订单模块数据库部分：</p>
<ul>
<li><p>首先，在数据库中创建三个数据库，并在对应的数据库中建表和添加记录；</p>
<pre><code class="hljs sql"><span class="hljs-comment">#建库</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> seata_order；

<span class="hljs-comment">#建表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_order(
    <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,
    <span class="hljs-string">`product_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'产品id'</span>,
    <span class="hljs-string">`count`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'数量'</span>,
    <span class="hljs-string">`money`</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">11</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'金额'</span>,
    <span class="hljs-string">`status`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单状态：0：创建中; 1：已完结'</span>
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">7</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;

//<span class="hljs-comment">--------------------------------------------------------</span>

<span class="hljs-comment">#建库</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> seata_storage；

<span class="hljs-comment">#建表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_storage(
    <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-string">`product_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'产品id'</span>,
    <span class="hljs-string">`total`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'总库存'</span>,
    <span class="hljs-string">`used`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'已用库存'</span>,
    <span class="hljs-string">`residue`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'剩余库存'</span>
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;
 
<span class="hljs-comment">#添加记录 </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_storage(<span class="hljs-string">`id`</span>,<span class="hljs-string">`product_id`</span>,<span class="hljs-string">`total`</span>,<span class="hljs-string">`used`</span>,<span class="hljs-string">`residue`</span>)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'1'</span>,<span class="hljs-string">'1'</span>,<span class="hljs-string">'100'</span>,<span class="hljs-string">'0'</span>,<span class="hljs-string">'100'</span>);

//<span class="hljs-comment">--------------------------------------------------------</span>

<span class="hljs-comment">#建库</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> seata_account；

<span class="hljs-comment">#建表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_account(
    <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'id'</span>,
    <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,
    <span class="hljs-string">`total`</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'总额度'</span>,
    <span class="hljs-string">`used`</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'已用余额'</span>,
    <span class="hljs-string">`residue`</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'剩余可用额度'</span>
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;
 
<span class="hljs-comment">#添加记录 </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_account(<span class="hljs-string">`id`</span>,<span class="hljs-string">`user_id`</span>,<span class="hljs-string">`total`</span>,<span class="hljs-string">`used`</span>,<span class="hljs-string">`residue`</span>) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'1'</span>,<span class="hljs-string">'1'</span>,<span class="hljs-string">'1000'</span>,<span class="hljs-string">'0'</span>,<span class="hljs-string">'1000'</span>)</code></pre>
</li>
<li><p>然后分别在对应的新建三个数据库中，再添加一张回滚日志表。<strong><code>注意：三个数据库都各自添加一张表，而这张表，三个数据库都添加的是一样的，这个表的sql语句在conf目录下的db_undo_log.sql文件中</code></strong>；</p>
<pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`undo_log`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`branch_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`xid`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`context`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`rollback_info`</span> LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`log_status`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`log_created`</span> DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`log_modified`</span> DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`ext`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-string">`ux_undo_log`</span> (<span class="hljs-string">`xid`</span>,<span class="hljs-string">`branch_id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;</code></pre>
</li>
</ul>
</li>
<li><p>订单模块IDEA代码部分：</p>
<ul>
<li><p>创建seata-order-service2001子项目(以下简称2001子项目)，并导入以下依赖；</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!--nacos--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--seata--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--feign--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--web-actuator--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--mysql-druid--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.37<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
</li>
<li><p>配置yml文件；</p>
<pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">2001</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">seata-order-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">alibaba:</span>
      <span class="hljs-attr">seata:</span>
        <span class="hljs-comment">#自定义事务组名称需要与seata-server中的对应</span>
        <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">dyf_tx_group</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/seata_order</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">Deng521314</span>

<span class="hljs-attr">feign:</span>
  <span class="hljs-attr">hystrix:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>

<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">io:</span>
      <span class="hljs-attr">seata:</span> <span class="hljs-string">info</span>

<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapperLocations:</span> <span class="hljs-string">classpath:mapper/*.xml</span></code></pre>
</li>
<li><p>在Resources目录下，创建一个新文件file.conf；</p>
<pre><code class="hljs txt">transport &#123;
  # tcp udt unix-domain-socket
  type &#x3D; &quot;TCP&quot;
  #NIO NATIVE
  server &#x3D; &quot;NIO&quot;
  #enable heartbeat
  heartbeat &#x3D; true
  #thread factory for netty
  thread-factory &#123;
    boss-thread-prefix &#x3D; &quot;NettyBoss&quot;
    worker-thread-prefix &#x3D; &quot;NettyServerNIOWorker&quot;
    server-executor-thread-prefix &#x3D; &quot;NettyServerBizHandler&quot;
    share-boss-worker &#x3D; false
    client-selector-thread-prefix &#x3D; &quot;NettyClientSelector&quot;
    client-selector-thread-size &#x3D; 1
    client-worker-thread-prefix &#x3D; &quot;NettyClientWorkerThread&quot;
    # netty boss thread size,will not be used for UDT
    boss-thread-size &#x3D; 1
    #auto default pin or 8
    worker-thread-size &#x3D; 8
  &#125;
  shutdown &#123;
    # when destroy server, wait seconds
    wait &#x3D; 3
  &#125;
  serialization &#x3D; &quot;seata&quot;
  compressor &#x3D; &quot;none&quot;
&#125;

service &#123;
  #这里的这个dyf_tx_group要和你自己配置的file.conf文件里自定义的事务组名称相同
  vgroup_mapping.dyf_tx_group &#x3D; &quot;default&quot;

  default.grouplist &#x3D; &quot;127.0.0.1:8091&quot;
  enableDegrade &#x3D; false
  disable &#x3D; false
  max.commit.retry.timeout &#x3D; &quot;-1&quot;
  max.rollback.retry.timeout &#x3D; &quot;-1&quot;
  disableGlobalTransaction &#x3D; false
&#125;


client &#123;
  async.commit.buffer.limit &#x3D; 10000
  lock &#123;
    retry.internal &#x3D; 10
    retry.times &#x3D; 30
  &#125;
  report.retry.count &#x3D; 5
  tm.commit.retry.count &#x3D; 1
  tm.rollback.retry.count &#x3D; 1
&#125;

## transaction log store
store &#123;
  ## store mode: file、db
  mode &#x3D; &quot;db&quot;

  ## file store
  file &#123;
    dir &#x3D; &quot;sessionStore&quot;

    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions
    max-branch-session-size &#x3D; 16384
    # globe session size , if exceeded throws exceptions
    max-global-session-size &#x3D; 512
    # file buffer size , if exceeded allocate new buffer
    file-write-buffer-cache-size &#x3D; 16384
    # when recover batch read size
    session.reload.read_size &#x3D; 100
    # async, sync
    flush-disk-mode &#x3D; async
  &#125;

  ## database store
  db &#123;
    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)&#x2F;BasicDataSource(dbcp) etc.
    datasource &#x3D; &quot;dbcp&quot;
    ## mysql&#x2F;oracle&#x2F;h2&#x2F;oceanbase etc.
    db-type &#x3D; &quot;mysql&quot;
    driver-class-name &#x3D; &quot;com.mysql.jdbc.Driver&quot;
    url &#x3D; &quot;jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;seata&quot;
    user &#x3D; &quot;root&quot;
    password &#x3D; &quot;Deng521314&quot;
    min-conn &#x3D; 1
    max-conn &#x3D; 3
    global.table &#x3D; &quot;global_table&quot;
    branch.table &#x3D; &quot;branch_table&quot;
    lock-table &#x3D; &quot;lock_table&quot;
    query-limit &#x3D; 100
  &#125;
&#125;
lock &#123;
  ## the lock store mode: local、remote
  mode &#x3D; &quot;remote&quot;

  local &#123;
    ## store locks in user&#39;s database
  &#125;

  remote &#123;
    ## store locks in the seata&#39;s server
  &#125;
&#125;
recovery &#123;
  #schedule committing retry period in milliseconds
  committing-retry-period &#x3D; 1000
  #schedule asyn committing retry period in milliseconds
  asyn-committing-retry-period &#x3D; 1000
  #schedule rollbacking retry period in milliseconds
  rollbacking-retry-period &#x3D; 1000
  #schedule timeout retry period in milliseconds
  timeout-retry-period &#x3D; 1000
&#125;

transaction &#123;
  undo.data.validation &#x3D; true
  undo.log.serialization &#x3D; &quot;jackson&quot;
  undo.log.save.days &#x3D; 7
  #schedule delete expired undo_log in milliseconds
  undo.log.delete.period &#x3D; 86400000
  undo.log.table &#x3D; &quot;undo_log&quot;
&#125;

## metrics settings
metrics &#123;
  enabled &#x3D; false
  registry-type &#x3D; &quot;compact&quot;
  # multi exporters use comma divided
  exporter-list &#x3D; &quot;prometheus&quot;
  exporter-prometheus-port &#x3D; 9898
&#125;

support &#123;
  ## spring
  spring &#123;
    # auto proxy the DataSource bean
    datasource.autoproxy &#x3D; false
  &#125;
&#125;</code></pre>
</li>
<li><p>同样的，在Resources下创建一个新文件registry.conf；</p>
<pre><code class="hljs txt">registry &#123;
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type &#x3D; &quot;nacos&quot;
 
  nacos &#123;
    serverAddr &#x3D; &quot;localhost:8848&quot;
    namespace &#x3D; &quot;&quot;
    cluster &#x3D; &quot;default&quot;
  &#125;
  eureka &#123;
    serviceUrl &#x3D; &quot;http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&quot;
    application &#x3D; &quot;default&quot;
    weight &#x3D; &quot;1&quot;
  &#125;
  redis &#123;
    serverAddr &#x3D; &quot;localhost:6379&quot;
    db &#x3D; &quot;0&quot;
  &#125;
  zk &#123;
    cluster &#x3D; &quot;default&quot;
    serverAddr &#x3D; &quot;127.0.0.1:2181&quot;
    session.timeout &#x3D; 6000
    connect.timeout &#x3D; 2000
  &#125;
  consul &#123;
    cluster &#x3D; &quot;default&quot;
    serverAddr &#x3D; &quot;127.0.0.1:8500&quot;
  &#125;
  etcd3 &#123;
    cluster &#x3D; &quot;default&quot;
    serverAddr &#x3D; &quot;http:&#x2F;&#x2F;localhost:2379&quot;
  &#125;
  sofa &#123;
    serverAddr &#x3D; &quot;127.0.0.1:9603&quot;
    application &#x3D; &quot;default&quot;
    region &#x3D; &quot;DEFAULT_ZONE&quot;
    datacenter &#x3D; &quot;DefaultDataCenter&quot;
    cluster &#x3D; &quot;default&quot;
    group &#x3D; &quot;SEATA_GROUP&quot;
    addressWaitTime &#x3D; &quot;3000&quot;
  &#125;
  file &#123;
    name &#x3D; &quot;file.conf&quot;
  &#125;
&#125;
 
config &#123;
  # file、nacos 、apollo、zk、consul、etcd3
  type &#x3D; &quot;file&quot;
 
  nacos &#123;
    serverAddr &#x3D; &quot;localhost&quot;
    namespace &#x3D; &quot;&quot;
  &#125;
  consul &#123;
    serverAddr &#x3D; &quot;127.0.0.1:8500&quot;
  &#125;
  apollo &#123;
    app.id &#x3D; &quot;seata-server&quot;
    apollo.meta &#x3D; &quot;http:&#x2F;&#x2F;192.168.1.204:8801&quot;
  &#125;
  zk &#123;
    serverAddr &#x3D; &quot;127.0.0.1:2181&quot;
    session.timeout &#x3D; 6000
    connect.timeout &#x3D; 2000
  &#125;
  etcd3 &#123;
    serverAddr &#x3D; &quot;http:&#x2F;&#x2F;localhost:2379&quot;
  &#125;
  file &#123;
    name &#x3D; &quot;file.conf&quot;
  &#125;
&#125;</code></pre>
</li>
<li><p><code>cn.dyf.springcloud.domain</code>目录下创建CommonResult类和Order实体类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonResult</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;

	<span class="hljs-keyword">private</span> Integer code;
	<span class="hljs-keyword">private</span> String  message;
	<span class="hljs-keyword">private</span> T       data;

	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CommonResult</span><span class="hljs-params">(Integer code, String message)</span></span>
<span class="hljs-function">	</span>&#123;
		<span class="hljs-keyword">this</span>(code,message,<span class="hljs-keyword">null</span>);
	&#125;
&#125;

<span class="hljs-comment">//------------------------------------</span>

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span></span>
<span class="hljs-class"></span>&#123;
	<span class="hljs-keyword">private</span> Long id;

	<span class="hljs-keyword">private</span> Long userId;  <span class="hljs-comment">//用户id</span>

	<span class="hljs-keyword">private</span> Long productId;  <span class="hljs-comment">//商品id</span>

	<span class="hljs-keyword">private</span> Integer count;  <span class="hljs-comment">//购买的商品数量</span>

	<span class="hljs-keyword">private</span> BigDecimal money;  <span class="hljs-comment">//总共消费金额</span>

	<span class="hljs-keyword">private</span> Integer status;  <span class="hljs-comment">//订单状态：0：创建中；1：已完结</span>
&#125;</code></pre>
</li>
<li><p>配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)  //使用<span class="hljs-title">seata</span>的数据源，而不是使用自带的数据源</span>
<span class="hljs-class">@<span class="hljs-title">EnableDiscoveryClient</span></span>
@MapperScan("cn.dyf.springcloud.dao")
<span class="hljs-meta">@EnableFeignClients</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeataOrder2001</span> </span>&#123;
	<span class="hljs-comment">//main方法</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;

		SpringApplication.run(SeataOrder2001<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>配置dao和对应的mapper；</p>
<pre><code>    <pre><code class="hljs xml">public interface OrderDao &#123;

	//下单
	void create(Order order);

	//修改订单状态
	void update(@Param("userId") Long userId,@Param("status") Integer status);

&#125;

//--------------------------------------

<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span>
<span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span>
<span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"cn.dyf.springcloud.dao.OrderDao"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"cn.dyf.springcloud.domain.Order"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"product_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"productId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"count"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"count"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"money"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"money"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"DECIMAL"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"create"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">""</span>&gt;</span>

        insert into t_order(id,user_id,product_id,count,money,status)
        values (null,#&#123;userId&#125;,#&#123;productId&#125;,#&#123;count&#125;,#&#123;money&#125;,0);

    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"update"</span>&gt;</span>
        update t_order set status = 1
        where userId = #&#123;userId&#125;
        and status = #&#123;status&#125;

    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre>

-   配置OrderService和对应的OrderServiceImpl类；

    <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderService</span> </span>&#123;

	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">(Order order)</span></span>;

&#125;

<span class="hljs-comment">//------------------------------------</span>

<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderService</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> OrderDao orderDao;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> StorageService storageService;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> AccountService accountService;


	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">(Order order)</span> </span>&#123;

		orderDao.create(order);
		log.info(<span class="hljs-string">"----------------订单创建成功，准备调用库存微服务"</span>);


		storageService.decrease(order.getProductId(),order.getCount());
		log.info(<span class="hljs-string">"----------------库存修改成功，准备调用扣钱微服务"</span>);

		accountService.decrease(order.getUserId(),order.getMoney());
		log.info(<span class="hljs-string">"----------------扣钱成功，调用完毕，准备修改订单状态"</span>);

		orderDao.update(order.getUserId(),order.getStatus());

	&#125;
&#125;</code></pre>

-   配置storageService和accountService；

    <pre><code class="hljs java"><span class="hljs-meta">@FeignClient</span>(<span class="hljs-string">"seata-account-service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AccountService</span> </span>&#123;

	<span class="hljs-comment">//告知商品id和购买的数量</span>
	<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/account/decrease"</span>)
	<span class="hljs-function">CommonResult <span class="hljs-title">decrease</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"userId"</span>)</span> Long userId, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"money"</span>)</span> BigDecimal money)</span>;
&#125;

<span class="hljs-comment">//------------------------</span>

<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"seata-storage-service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StorageService</span> </span>&#123;

	<span class="hljs-comment">//告知商品id和购买的数量</span>
	<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/storage/decrease"</span>)
	<span class="hljs-function">CommonResult <span class="hljs-title">decrease</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"productId"</span>)</span> Long productId,@<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"count"</span>)</span> Integer count)</span>;

&#125;</code></pre>

-   配置OrderController；

    <pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> OrderService orderService;

	<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/order/create"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">create</span><span class="hljs-params">(@RequestBody Order order)</span></span>&#123;
		orderService.create(order);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"订单创建成功"</span>);
	&#125;
&#125;</code></pre>

-   配置DataSource(德鲁伊数据源)配置类；

    <pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceProxyConfig</span> </span>&#123;


	<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;mybatis.mapperLocations&#125;"</span>)
	<span class="hljs-keyword">private</span> String mapperLocations;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">druidDataSource</span><span class="hljs-params">()</span></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DruidDataSource();
	&#125;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> DataSourceProxy <span class="hljs-title">dataSourceProxy</span><span class="hljs-params">(DataSource dataSource)</span> </span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSourceProxy(dataSource);
	&#125;


	<span class="hljs-meta">@Bean</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">sqlSessionFactoryBean</span><span class="hljs-params">(DataSourceProxy dataSourceProxy)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
		SqlSessionFactoryBean sqlSessionFactoryBean = <span class="hljs-keyword">new</span> SqlSessionFactoryBean();
		sqlSessionFactoryBean.setDataSource(dataSourceProxy);
		sqlSessionFactoryBean.setMapperLocations(<span class="hljs-keyword">new</span> PathMatchingResourcePatternResolver().getResources(mapperLocations));
		sqlSessionFactoryBean.setTransactionFactory(<span class="hljs-keyword">new</span> SpringManagedTransactionFactory());
		<span class="hljs-keyword">return</span> sqlSessionFactoryBean.getObject();
	&#125;

&#125;</code></pre></code></pre></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>分别创建seata-storage-service2002库存模块和seata-account-service2003账户模块，总体步骤和上面的订单模块差不多，下面是不同的部分；</p>
<ul>
<li><p>配置domain类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Storage</span> </span>&#123;

	<span class="hljs-keyword">private</span> Long id;

	<span class="hljs-comment">// 产品id</span>
	<span class="hljs-keyword">private</span> Long productId;

	<span class="hljs-comment">//总库存</span>
	<span class="hljs-keyword">private</span> Integer total;


	<span class="hljs-comment">//已用库存</span>
	<span class="hljs-keyword">private</span> Integer used;


	<span class="hljs-comment">//剩余库存</span>
	<span class="hljs-keyword">private</span> Integer residue;
&#125;

<span class="hljs-comment">//=======================================================</span>

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span> </span>&#123;

	<span class="hljs-keyword">private</span> Long id;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 用户id</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-keyword">private</span> Long userId;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 总额度</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-keyword">private</span> BigDecimal total;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 已用额度</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-keyword">private</span> BigDecimal used;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 剩余额度</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-keyword">private</span> BigDecimal residue;
&#125;</code></pre>
</li>
<li><p>配置Dao和Mapper；</p>
<pre><code class="hljs xml">public interface StorageDao &#123;

	//扣减库存信息
	void decrease(@Param("productId") Long productId, @Param("count") Integer count);
&#125;

//--------------------------------

<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
 
 
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.atguigu.springcloud.alibaba.dao.StorageDao"</span>&gt;</span>
 
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.atguigu.springcloud.alibaba.domain.Storage"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"product_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"productId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"used"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"used"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"residue"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"residue"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
 
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"decrease"</span>&gt;</span>
        UPDATE
            t_storage
        SET
            used = used + #&#123;count&#125;,residue = residue - #&#123;count&#125;
        WHERE
            product_id = #&#123;productId&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
 
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
 
//======================================================= 
 
public interface AccountDao &#123;

	/**
	 * 扣减账户余额
	 */
	void decrease(@Param("userId") Long userId, @Param("money") BigDecimal money);
&#125;

//----------------------------------------

<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"cn.dyf.springcloud.dao.AccountDao"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"cn.dyf.springcloud.domain.Account"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"DECIMAL"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"used"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"used"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"DECIMAL"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"residue"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"residue"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"DECIMAL"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"decrease"</span>&gt;</span>
        UPDATE t_account
        SET
          residue = residue - #&#123;money&#125;,used = used + #&#123;money&#125;
        WHERE
          user_id = #&#123;userId&#125;;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre>
</li>
<li><p>配置service和对应的Impl；</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StorageService</span> </span>&#123;

	<span class="hljs-comment">// 扣减库存</span>
	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrease</span><span class="hljs-params">(Long productId, Integer count)</span></span>;

&#125;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StorageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">StorageService</span></span>&#123;

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(StorageServiceImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> StorageDao storageDao;

	<span class="hljs-comment">// 扣减库存</span>
	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrease</span><span class="hljs-params">(Long productId, Integer count)</span> </span>&#123;
		LOGGER.info(<span class="hljs-string">"-------&gt;storage-service中扣减库存开始"</span>);
		storageDao.decrease(productId,count);
		LOGGER.info(<span class="hljs-string">"-------&gt;storage-service中扣减库存结束"</span>);
	&#125;

&#125;

<span class="hljs-comment">//=======================================================</span>

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AccountService</span> </span>&#123;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 扣减账户余额</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrease</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"userId"</span>)</span> Long userId, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"money"</span>)</span> BigDecimal money)</span>;

&#125;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AccountService</span> </span>&#123;

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AccountServiceImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;


	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> AccountDao accountDao;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 扣减账户余额</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrease</span><span class="hljs-params">(Long userId, BigDecimal money)</span> </span>&#123;

		LOGGER.info(<span class="hljs-string">"-------&gt;account-service中扣减账户余额开始"</span>);
		<span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">20</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;
		accountDao.decrease(userId,money);
		LOGGER.info(<span class="hljs-string">"-------&gt;account-service中扣减账户余额结束"</span>);
	&#125;
&#125;</code></pre>
</li>
<li><p>配置controller类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StorageController</span> </span>&#123;

	<span class="hljs-meta">@Autowired</span>
	<span class="hljs-keyword">private</span> StorageService storageService;


	<span class="hljs-comment">//扣减库存</span>
	<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/storage/decrease"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">decrease</span><span class="hljs-params">(Long productId, Integer count)</span> </span>&#123;
		storageService.decrease(productId, count);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"扣减库存成功！"</span>);
	&#125;
&#125;

<span class="hljs-comment">//===========================================</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountController</span> </span>&#123;

	<span class="hljs-meta">@Resource</span>
	<span class="hljs-keyword">private</span> AccountService accountService;

	<span class="hljs-comment">/**</span>
<span class="hljs-comment">	 * 扣减账户余额</span>
<span class="hljs-comment">	 */</span>
	<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/account/decrease"</span>)
	<span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title">decrease</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"userId"</span>)</span> Long userId, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"money"</span>)</span> BigDecimal money)</span>&#123;
		accountService.decrease(userId,money);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CommonResult(<span class="hljs-number">200</span>,<span class="hljs-string">"扣减账户余额成功！"</span>);
	&#125;
&#125;</code></pre>
</li>
<li><p>配置类和2001子项目一样即可；最后就是配置启动类；</p>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">EnableDiscoveryClient</span></span>
<span class="hljs-class">@<span class="hljs-title">EnableFeignClients</span></span>
@MapperScan("cn.dyf.springcloud.dao")
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeataStorage2002</span> </span>&#123;
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">	</span>&#123;
		SpringApplication.run(SeataStorage2002<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;
	&#125;
&#125;

<span class="hljs-comment">//===========================================</span>

<span class="hljs-meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">EnableDiscoveryClient</span></span>
<span class="hljs-class">@<span class="hljs-title">EnableFeignClients</span></span>
@MapperScan("cn.dyf.springcloud.dao")
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeataAccount2003</span> </span>&#123;
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
		SpringApplication.run(SeataAccount2003<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;
	&#125;
&#125;</code></pre>
</li>
<li><p>此时，开启Nacos、Seata，以及2001、2002、2003微服务，调用2001微服务，会出现，订单增加了，库存减少了，余额也扣钱了，但是订单状态仍然是0的状态，这是因为我让付钱环节睡了20秒，所以，前台返回的页面是报错误异常，这就出现了事务问题，微服务之间的调用出现了事务问题，所以这里就需要Seata出场了，只需要在订单的业务逻辑中添加一个注解@GlobalTransactional；</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GlobalTransactional</span>(name = <span class="hljs-string">"tc_order"</span>,rollbackFor = Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">create</span>(<span class="hljs-title">Order</span> <span class="hljs-title">order</span>) </span>&#123;

    orderDao.create(order);
    log.info(<span class="hljs-string">"----------------订单创建成功，准备调用库存微服务"</span>);


    storageService.decrease(order.getProductId(),order.getCount());
    log.info(<span class="hljs-string">"----------------库存修改成功，准备调用扣钱微服务"</span>);

    accountService.decrease(order.getUserId(),order.getMoney());
    log.info(<span class="hljs-string">"----------------扣钱成功，调用完毕，准备修改订单状态"</span>);

    orderDao.update(order.getUserId(),order.getStatus());

&#125;

说明：<span class="hljs-meta">@GlobalTransactional</span>注解就是用于处理微服务全局的事务问题，其中name属性是为事务起一个名称，rollbackFor属性则是表示，遇到哪些异常就回滚事务。</code></pre>

</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/1-%EB%8C%80%ED%95%99%EA%B5%90-%EC%9D%BC-%ED%95%99%EB%85%84/">1.대학교 일 학년</a>
                    
                      <a class="hover-with-bg" href="/categories/1-%EB%8C%80%ED%95%99%EA%B5%90-%EC%9D%BC-%ED%95%99%EB%85%84/03-Java/">03.Java</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%A4%A7%E4%B8%80%E8%AF%BE%E7%A8%8B/">大一课程</a>
                    
                      <a class="hover-with-bg" href="/tags/SpringCloud/">SpringCloud</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/07/13/PHP--%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="hidden-mobile">01.PHP--学习笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "05.SpringCloud--学习笔记&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
